<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FundAdvisor Pro | ÊûÅÁÆÄ„ÄÅ‰∏ì‰∏ö„ÄÅAIÈ©±Âä® (v4.0 Edge)</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #f39c12;
            /* Fintech Gold */
            --primary-glow: rgba(243, 156, 18, 0.5);
            --secondary: #e67e22;
            --accent: #ff6b6b;
            --success: #00d4aa;
            /* Fintech Green */
            --warning: #f59e0b;
            --danger: #ff4757;
            --bg-dark: #1a1a2e;
            /* Fintech Deep Blue */
            --card-bg: rgba(255, 255, 255, 0.05);
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            --border-color: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(244, 63, 94, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            line-height: 1.6;
        }

        [v-cloak] {
            display: none;
        }

        .app-container {
            max-width: 100%;
            margin: 0;
            padding: 2rem;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
        }

        .sidebar {
            position: sticky;
            top: 2rem;
            height: fit-content;
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 16px var(--primary-glow);
        }

        .brand-name {
            font-family: 'Outfit', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem 1rem;
            border-radius: 14px;
            color: var(--text-muted);
            font-weight: 500;
            transition: var(--transition);
            background: transparent;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }

        .nav-item:hover {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-item.active {
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            box-shadow: 0 8px 20px var(--primary-glow);
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 1.5rem;
            transition: var(--transition);
        }

        .glass-card:hover {
            border-color: rgba(255, 255, 255, 0.15);
            background: rgba(30, 41, 59, 0.8);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .metric-label {
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-value {
            font-family: 'Outfit', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .item-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.25rem;
        }

        .fund-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 1.25rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .fund-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            opacity: 0.5;
        }

        .fund-card:hover {
            transform: translateY(-8px);
            background: rgba(255, 255, 255, 0.06);
            border-color: var(--primary);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .fund-info-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .fund-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .fund-code {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .score-pill {
            padding: 0.35rem 0.75rem;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.85rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .score-A {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .score-B {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .score-C {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .score-D {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        /* Core Metrics Grid */
        .core-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .core-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .core-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .core-card:hover .core-value {
            transform: scale(1.1);
        }

        .core-title {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .core-value {
            font-family: 'Outfit', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 0.25rem;
            transition: var(--transition);
        }

        .core-sub {
            font-size: 0.8rem;
            color: var(--text-muted);
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        /* Updated Sentiment Gauge */
        .sentiment-dashboard {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(20, 30, 48, 0.6);
            border-radius: 24px;
            border: 1px solid var(--border-color);
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .sentiment-dashboard::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.5;
        }

        .gauge-container {
            position: relative;
            width: 200px;
            height: 100px;
            /* Half circle */
            margin-right: 2rem;
        }

        .gauge-arc {
            width: 200px;
            height: 200px;
            background: conic-gradient(from 270deg,
                    #ff6b6b 0deg,
                    #f59e0b 60deg,
                    #00d4aa 120deg,
                    #00d4aa 180deg);
            border-radius: 50%;
            mask: radial-gradient(transparent 65%, black 66%);
            -webkit-mask: radial-gradient(transparent 65%, black 66%);
            transform: rotate(-90deg);
            clip-path: inset(0 0 50% 0);
            /* Cut bottom half */
        }

        .gauge-pointer {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 4px;
            height: 90px;
            background: #fff;
            transform-origin: bottom center;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            transition: transform 1s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 5;
        }

        .gauge-center-point {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            z-index: 6;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .gauge-labels {
            display: flex;
            justify-content: space-between;
            width: 220px;
            margin-left: -10px;
            margin-top: 10px;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        /* Advice Cards Grid */
        .advice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .advice-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .advice-card:hover {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-5px);
        }

        .advice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .advice-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .advice-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 0.5rem;
        }

        .advice-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .overall-score-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .overall-score-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--primary), var(--success));
            border-radius: 4px;
            width: 0%;
            transition: width 1.5s ease-out;
        }

        /* Prediction Card Styles */
        .predict-container {
            margin-top: 2rem;
        }

        .predict-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .predict-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.05));
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 20px;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            cursor: pointer;
        }

        .predict-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.2);
        }

        .predict-badge {
            position: absolute;
            top: 0;
            right: 0;
            padding: 4px 12px;
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            border-bottom-left-radius: 12px;
            text-transform: uppercase;
        }

        .predict-prob {
            font-family: 'Outfit', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: var(--success);
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        /* Entity Chips (Modern Tags) */
        .entity-link {
            display: inline-flex;
            align-items: center;
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
            padding: 2px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin: 2px 4px;
            border: 1px solid rgba(99, 102, 241, 0.2);
            text-decoration: none;
            line-height: normal;
            vertical-align: baseline;
        }

        .entity-link:hover {
            background: rgba(99, 102, 241, 0.3);
            color: white;
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .highlight-gold {
            color: #ffd700;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* Radar Chart Wrapper */
        .radar-box {
            width: 100%;
            height: 200px;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Rank Bar */
        .rank-bar-container {
            height: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
            width: 100%;
        }

        .rank-bar-fill {
            height: 100%;
            background: linear-gradient(to right, #6366f1, #10b981);
            transition: width 1s ease;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .badge-hot {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-steady {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .realtime-badge {
            position: absolute;
            top: -5px;
            right: -30px;
            font-size: 0.65rem;
            background: #ef4444;
            color: white;
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        /* Radar Overlay */
        .radar-overlay {
            position: absolute;
            top: 60px;
            right: 0;
            width: 280px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1rem;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .radar-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .radar-value {
            font-weight: 700;
            color: var(--primary);
        }

        /* DCA Simulation Section */
        .dca-panel {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid var(--glass-border);
        }

        .dca-switch {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .toggle-track {
            width: 40px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            position: relative;
            transition: background 0.3s;
        }

        .toggle-thumb {
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .dca-active .toggle-track {
            background: var(--primary);
        }

        .dca-active .toggle-thumb {
            transform: translateX(20px);
        }

        /* PK Mode Comparison */
        .compare-bar {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid var(--primary);
            border-radius: 50px;
            padding: 0.75rem 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.4);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100px);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .compare-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: white;
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .pk-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 900px;
            background: var(--bg-dark);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2.5rem;
            z-index: 2000;
            box-shadow: 0 0 100px rgba(0, 0, 0, 0.8);
            max-height: 90vh;
            overflow-y: auto;
        }

        .pk-grid {
            display: grid;
            grid-template-columns: 120px 1fr 1fr;
            gap: 1.5rem;
            align-items: center;
        }

        .pk-metric-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-align: center;
        }

        .pk-value-cell {
            padding: 1.25rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.03);
            text-align: center;
        }

        .winner {
            border: 2px solid var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .pk-v-divider {
            height: 100%;
            width: 1px;
            background: var(--glass-border);
            grid-row: span 10;
        }

        .ai-banner {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 20px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .ai-content {
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.9);
        }

        .ai-content strong {
            color: #fef08a;
        }

        .pro-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 1rem 1.25rem;
            color: white;
            width: 100%;
            font-size: 1rem;
            transition: var(--transition);
        }

        .pro-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        .pro-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 14px;
            padding: 1rem 2rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .pro-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--primary-glow);
        }

        .pro-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .text-up,
        .font-up {
            color: var(--success);
        }

        .text-down,
        .font-down {
            color: var(--accent);
        }

        .spinner-pro {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            cursor: pointer;
        }

        .disclaimer {
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.75rem;
            padding: 20px 0;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* Analysis Cards (v4.0) */
        .analysis-cards-container {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding: 0.5rem 0.25rem 1.5rem;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .analysis-cards-container::-webkit-scrollbar {
            display: none;
        }

        .analysis-card {
            min-width: 280px;
            max-width: 280px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            flex-shrink: 0;
            transition: var(--transition);
        }

        .analysis-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .analysis-card .card-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .analysis-card .card-subtitle {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .analysis-card .stress-value {
            font-family: 'Outfit', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            margin: 0.5rem 0;
        }

        .analysis-card .card-footer {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: auto;
        }

        .analysis-card .points-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .analysis-card .point-item {
            display: flex;
            gap: 0.5rem;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .analysis-card .point-item .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--primary);
            margin-top: 6px;
            flex-shrink: 0;
        }

        /* Deep Dive Overlay */
        .deep-dive-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            z-index: 200;
            overflow-y: auto;
            padding: 2rem;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .close-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .detail-tabs {
            display: flex;
            gap: 2rem;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 2rem;
        }

        .detail-tab {
            padding: 1rem 0;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            font-weight: 500;
            transition: var(--transition);
        }

        .detail-tab:hover {
            color: white;
        }

        .detail-tab.active {
            color: var(--primary);
            font-weight: 600;
        }

        .detail-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary);
            box-shadow: 0 -2px 10px var(--primary-glow);
        }

        .manager-card {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid var(--glass-border);
        }

        /* AI Strategy UI (Pro) */
        .strategy-container {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            color: var(--text-main);
        }

        .strategy-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
        }

        .strategy-card:hover {
            background: rgba(30, 41, 59, 0.8);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .strategy-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            opacity: 0.8;
        }

        .strategy-card.recommend::before {
            background: var(--success);
        }

        .strategy-card.avoid::before {
            background: var(--danger);
        }

        .strategy-card.highlight::before {
            background: #fbbf24;
        }

        .strategy-title {
            font-size: 1rem;
            font-weight: 800;
            color: white;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-family: 'Outfit', sans-serif;
        }

        .strategy-content {
            font-size: 0.9rem;
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.85);
        }

        .highlight-gold {
            color: #fbbf24;
            font-weight: 700;
        }

        .entity-link {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            margin: 0 2px;
            transition: all 0.2s;
        }

        .entity-link:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .strategy-quote {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--primary);
            padding: 1rem 1.25rem;
            border-radius: 4px 12px 12px 4px;
            margin: 1rem 0;
            font-style: italic;
            color: #f1f5f9;
        }

        .market-tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 6px;
            margin-bottom: 6px;
        }

        .tag-red {
            background: rgba(255, 59, 48, 0.2);
            color: #ff453a;
            border: 1px solid rgba(255, 59, 48, 0.3);
        }

        .tag-green {
            background: rgba(48, 209, 88, 0.2);
            color: #32d74b;
            border: 1px solid rgba(48, 209, 88, 0.3);
        }

        .tag-blue {
            background: rgba(10, 132, 255, 0.2);
            color: #0a84ff;
            border: 1px solid rgba(10, 132, 255, 0.3);
        }


        .manager-avatar {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #475569;
            font-weight: bold;
        }

        .news-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .news-item {
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            transition: var(--transition);
        }

        .news-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .news-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .rank-table {
            width: 100%;
            border-collapse: collapse;
            color: var(--text-main);
        }

        .rank-table th {
            text-align: left;
            padding: 1rem;
            color: var(--text-muted);
            font-weight: 500;
            border-bottom: 1px solid var(--glass-border);
        }

        .rank-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .rank-badge {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.85rem;
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .rank-1 {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }

        .rank-2 {
            background: linear-gradient(135deg, #94a3b8, #475569);
            box-shadow: 0 4px 12px rgba(148, 163, 184, 0.3);
        }

        .rank-3 {
            background: linear-gradient(135deg, #cd7f32, #a0522d);
            box-shadow: 0 4px 12px rgba(205, 127, 50, 0.3);
        }

        .strategy-card small {
            color: #7f8c8d;
            font-size: 0.8rem;
            margin-left: 0.25rem;
        }

        /* New Strategy UI Styles */
        .strategy-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .sector-modal-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
        }

        /* Phase 3: PK & Diagnostics */
        .pk-matrix-3 {
            display: grid;
            grid-template-columns: 180px 1fr 1fr 1fr;
            gap: 1px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pk-cell {
            background: #0f172a;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 60px;
        }

        .pk-header-cell {
            background: rgba(255, 255, 255, 0.03);
            font-weight: 700;
            color: var(--text-muted);
            justify-content: flex-start;
            padding-left: 1.5rem;
        }

        /* Market Hotspots Redesign (V4.2) */
        .hotspot-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.4) 0%, rgba(15, 23, 42, 0.6) 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .hotspot-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            background: rgba(30, 41, 59, 0.6);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }

        .hotspot-card::after {
            content: '';
            position: absolute;
            left: 0;
            top: 20px;
            bottom: 20px;
            width: 3px;
            background: var(--primary);
            border-radius: 0 4px 4px 0;
            opacity: 0.6;
        }

        .hotspot-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 1.25rem;
            line-height: 1.4;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-family: 'Outfit', sans-serif;
        }

        .hotspot-section {
            margin-bottom: 1.25rem;
        }

        .hotspot-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--primary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hotspot-content {
            font-size: 0.9rem;
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.75);
            margin: 0;
        }

        .hotspot-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .hotspot-tag {
            padding: 4px 12px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            color: #818cf8;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .hotspot-tag:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .hotspot-comment {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 12px 16px;
            font-style: italic;
            border-left: 2px solid rgba(255, 255, 255, 0.1);
        }

        .similarity-alert {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.2);
            color: #eab308;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
        }

        .stress-test-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: transform 0.3s ease;
        }

        .stress-test-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
        }

        /* AI Chat Panel (Phase 4) */
        .chat-panel {
            position: fixed;
            right: -450px;
            top: 0;
            width: 450px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2100;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-panel.active {
            right: 0;
        }

        .floating-ai-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1900;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
            transition: var(--transition);
        }

        .floating-ai-btn:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .ai-icon-inner {
            font-size: 1.5rem;
        }

        .ai-dot {
            position: absolute;
            top: 15%;
            right: 15%;
            width: 12px;
            height: 12px;
            background: var(--success);
            border: 2px solid #0f172a;
            border-radius: 50%;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .chat-header {
            padding: 1.5rem;
            background: linear-gradient(to right, var(--primary), #4f46e5);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            max-width: 85%;
            padding: 1rem;
            border-radius: 16px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
        }

        .message-ai {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            border-bottom-left-radius: 2px;
        }

        .message-user {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .chat-input-area {
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input-container {
            display: flex;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input {
            flex: 1;
            background: none;
            border: none;
            color: white;
            padding: 0.5rem;
            outline: none;
            font-size: 0.95rem;
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .fund-mini-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0.75rem;
            margin-top: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .fund-mini-card:hover {
            transform: translateX(5px);
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .allocation-bar {
            height: 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            overflow: hidden;
            display: flex;
            margin: 1rem 0;
        }

        .alloc-equity {
            background: var(--primary);
        }

        .alloc-bond {
            background: #6366f1;
        }

        .alloc-cash {
            background: #94a3b8;
        }

        .filter-drawer {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100%;
            background: #0f172a;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 2000;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 2rem;
            box-shadow: -20px 0 50px rgba(0, 0, 0, 0.5);
        }

        .filter-drawer.active {
            right: 0;
        }

        .filter-group {
            margin-bottom: 2rem;
        }

        .filter-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: block;
        }

        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .filter-chip {
            padding: 6px 12px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .data-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 1.2rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .data-card:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-2px);
        }

        /* Fund Channel Specific Styles */
        .sector-scroll-container {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding: 0.5rem 0 1.5rem;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .sector-scroll-container::-webkit-scrollbar {
            height: 4px;
        }

        .sector-scroll-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .sector-scroll-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .sector-mini-card {
            flex: 0 0 180px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .sector-mini-card:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--primary-glow);
        }

        .sector-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sector-info {
            flex: 1;
        }

        .sector-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.15rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sector-gain {
            font-size: 0.85rem;
            font-family: 'Outfit';
            font-weight: 700;
        }

        .ranking-tabs {
            display: flex;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 12px;
        }

        .ranking-tab {
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
        }

        .ranking-tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .ranking-tab.active {
            color: white;
            background: var(--primary);
            box-shadow: 0 2px 8px var(--primary-glow);
        }

        .section-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .data-number {
            font-size: 2rem;
            font-weight: 800;
            color: #FFB800;
            line-height: 1.2;
            margin-bottom: 0.25rem;
            font-family: 'Outfit', sans-serif;
        }

        .data-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .ai-summary-box {
            background: rgba(255, 255, 255, 0.02);
            border-left: 3px solid #FFB800;
            padding: 1rem 1.5rem;
            border-radius: 0 8px 8px 0;
            font-size: 0.95rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }

        .advice-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .advice-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .advice-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--card-color, #7f8c8d);
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .advice-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.06);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border-color: var(--card-color);
        }

        .advice-card.active {
            border-color: var(--card-color);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3), inset 0 0 20px rgba(255, 255, 255, 0.02);
        }

        .advice-card.active::before {
            opacity: 1;
            box-shadow: 2px 0 10px var(--card-color);
        }

        .advice-card:hover::before {
            opacity: 1;
        }

        .advice-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .advice-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--card-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .advice-desc {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .advice-arrow {
            margin-top: auto;
            align-self: flex-end;
            color: var(--card-color);
            font-size: 0.9rem;
            opacity: 0;
            transform: translateX(-5px);
            transition: all 0.3s ease;
        }

        .advice-card:hover .advice-arrow {
            opacity: 1;
            transform: translateX(0);
        }

        /* Sentiment & Sector Details Enhancement */
        .sentiment-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pill-fear-extreme {
            color: #f87171;
            border-color: #f8717144;
        }

        .pill-fear {
            color: #fb923c;
            border-color: #fb923c44;
        }

        .pill-neutral {
            color: #94a3b8;
            border-color: #94a3b844;
        }

        .pill-greed {
            color: #4ade80;
            border-color: #4ade8044;
        }

        .pill-greed-extreme {
            color: #22d3ee;
            border-color: #22d3ee44;
        }

        .breadth-bar {
            height: 4px;
            display: flex;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
            background: rgba(255, 255, 255, 0.05);
        }

        .breadth-up {
            background: var(--up);
            height: 100%;
        }

        .breadth-down {
            background: var(--down);
            height: 100%;
        }

        .sector-modal-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <!-- ÈîôËØØÊèêÁ§∫ -->
        <div v-if="errorMsg" class="error-toast" @click="errorMsg=''">{{ errorMsg }}</div>

        <div class="app-container">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="brand">
                    <div class="brand-icon">üí∞</div>
                    <div class="brand-name">FundAdvisor Pro</div>
                </div>

                <nav class="nav-menu">
                    <button class="nav-item" :class="{active: mode==='recommend'}" @click="switchMode('recommend')">
                        üéØ Êô∫ËÉΩÊé®Ëçê
                    </button>
                    <button class="nav-item" :class="{active: mode==='channel'}" @click="switchMode('channel')">
                        üèÜ Âü∫ÈáëÈ¢ëÈÅì
                    </button>
                    <button class="nav-item" :class="{active: mode==='gainers'}" @click="switchMode('gainers')">
                        üìà Ê∂®ÂπÖÊ¶úÂçï
                    </button>
                    <button class="nav-item" :class="{active: mode==='search'}" @click="switchMode('search')">
                        üîç Ê∑±Â∫¶ÊêúÁ¥¢
                    </button>
                    <button class="nav-item" :class="{active: mode==='portfolio'}" @click="switchMode('portfolio')">
                        üíº ËµÑ‰∫ßÊåÅ‰ªì
                    </button>
                    <button class="nav-item" :class="{active: mode==='watchlist'}" @click="switchMode('watchlist')">
                        ‚≠ê ÊàëÁöÑËá™ÈÄâ
                    </button>
                    <button class="nav-item" :class="{active: mode==='macro'}"
                        @click="switchMode('macro'); fetchMacroData();">
                        üåê ÂÆèËßÇËßÜÈáé
                    </button>
                    <button class="nav-item" :class="{active: mode==='tools'}" @click="switchMode('tools')">
                        üõ†Ô∏è ‰∏ì‰∏öÂ∑•ÂÖ∑
                    </button>
                </nav>

                <div style="margin-top: auto; padding-top: 2rem;">
                    <button class="nav-item" @click="showUpdateDialog = true">
                        üîÑ ÂêåÊ≠•‰∫ëÁ´ØÂø´ÁÖß
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Dynamic Emotional Greeting -->
                <div class="glass-card"
                    style="margin-bottom: 2rem; padding: 1rem 1.5rem; border-left: 4px solid var(--primary); display: flex; align-items: center; gap: 1rem;">
                    <div style="font-size: 1.2rem;">üí°</div>
                    <div style="font-size: 0.95rem; font-weight: 500; color: var(--text-muted);">{{ dynamicGreeting }}
                    </div>
                </div>

                <template v-if="mode === 'recommend'">
                    <!-- 1. Sentiment Dashboard (Top) -->
                    <!-- Modular Insight Grid -->
                    <!-- Modular Insight Grid -->
                    <div
                        style="display: grid; grid-template-columns: 240px 1fr; gap: 1.5rem; margin-bottom: 2rem; align-items: start;">
                        <!-- Left Module: Market Sentiment -->
                        <div class="glass-card"
                            style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 1.5rem;">
                            <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Â∏ÇÂú∫ÊÉÖÁª™ÊåáÊï∞
                            </div>
                            <div style="font-size: 3.5rem; font-weight: 800; line-height: 1; margin-bottom: 0.5rem;"
                                :style="{color: (recommendations?.market_sentiment || 50) > 60 ? 'var(--primary)' : ((recommendations?.market_sentiment || 50) < 40 ? 'var(--success)' : '#ecf0f1')}">
                                {{ recommendations?.market_sentiment || 50 }}
                            </div>
                            <div class="score-pill"
                                :class="{'score-A': (recommendations?.market_sentiment || 50) >= 70, 'score-B': (recommendations?.market_sentiment || 50) >= 50 && (recommendations?.market_sentiment || 50) < 70, 'score-C': (recommendations?.market_sentiment || 50) < 50}"
                                style="margin-bottom: 0.75rem; font-size: 1rem; padding: 4px 12px;">
                                {{ getSentimentText(recommendations?.market_sentiment || 50) }}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">
                                üìÖ {{ new Date().toLocaleDateString() }}
                            </div>
                        </div>

                        <!-- Right Module: AI Strategy Insight -->
                        <!-- Right Module: AI Strategy Insight (New Modular Design) -->
                        <div style="display: flex; flex-direction: column;">
                            <div
                                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; padding-left: 0.5rem;">
                                <h2 class="section-title" style="font-size: 1.2rem; margin: 0;">üß† AI Á≠ñÁï•Ê¥ûÂØü</h2>
                            </div>

                            <div v-if="loading" class="glass-card"
                                style="min-height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                                <div class="spinner-pro" style="margin-right: 10px;"></div> Ê≠£Âú®ÁîüÊàêÁ≠ñÁï•...
                            </div>

                            <div v-else-if="!recommendations" class="glass-card"
                                style="min-height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                                ÊöÇÊó†Êï∞ÊçÆÔºåËØ∑ÂêåÊ≠•‰∫ëÁ´ØÂø´ÁÖß
                            </div>

                            <div v-else class="strategy-container">
                                <!-- 1. Stats Grid -->
                                <div class="stats-grid">
                                    <div class="data-card">
                                        <div class="data-number" style="color: #FFB800">
                                            {{ recommendations?.stats?.avg_score || '47.3' }}<span
                                                style="font-size:12px; color:var(--text-muted); font-weight:400;">ÂàÜ</span>
                                        </div>
                                        <div class="data-label">Âπ≥ÂùáËØÑÂàÜ(‰∏•ÈÄâÊ±†)</div>
                                    </div>
                                    <div class="data-card">
                                        <div class="data-number" style="color: #4ECDC4">
                                            {{ recommendations?.stats?.high_alpha_count || '86' }}<span
                                                style="font-size:12px; color:var(--text-muted); font-weight:400;">Âè™</span>
                                        </div>
                                        <div class="data-label">È´òAlphaÂü∫Èáë(>10%)</div>
                                    </div>
                                    <div class="data-card">
                                        <div class="data-number" style="color: #96CEB4">
                                            {{ recommendations?.stats?.low_risk_count || '32' }}<span
                                                style="font-size:12px; color:var(--text-muted); font-weight:400;">Âè™</span>
                                        </div>
                                        <div class="data-label">‰ΩéÈ£éÈô©Á®≥ÂÅ•(&lt;15%)</div>
                                    </div>
                                </div>

                                <!-- 2. AI Summary Text -->
                                <div class="ai-summary-box" v-if="recommendations.ai_summary"
                                    v-html="renderMarkdown(recommendations.ai_summary)"></div>

                                <!-- 3. Advice Grid -->
                                <div class="advice-grid">
                                    <!-- TOP10 -->
                                    <div class="advice-card" :class="{active: recTab === 'top10'}"
                                        style="--card-color: #FF6B6B" @click="recTab='top10'">
                                        <div class="advice-header">
                                            <div class="advice-title"><span style="font-size:1.2rem">üèÜ</span> TOP10 Á≤æÈÄâ
                                            </div>
                                            <div v-if="recTab === 'top10'"
                                                style="font-size: 0.75rem; color: var(--card-color); font-weight: 700; border: 1px solid var(--card-color); padding: 2px 6px; border-radius: 4px;">
                                                ÂΩìÂâçÈÄâ‰∏≠</div>
                                        </div>
                                        <div class="advice-desc">ÁªºÂêàËØÑÂàÜÊúÄÈ´òÁöÑÂü∫ÈáëÔºåÈÄÇÂêà‰Ωú‰∏∫Ê†∏ÂøÉÊåÅ‰ªì</div>
                                        <div class="advice-arrow">Êü•ÁúãËØ¶ÊÉÖ ‚Üí</div>
                                    </div>
                                    <!-- High Alpha -->
                                    <div class="advice-card" :class="{active: recTab === 'high_alpha'}"
                                        style="--card-color: #4ECDC4" @click="recTab='high_alpha'">
                                        <div class="advice-header">
                                            <div class="advice-title"><span style="font-size:1.2rem">üöÄ</span> È´ò Alpha
                                                ËøõÊîª</div>
                                            <div v-if="recTab === 'high_alpha'"
                                                style="font-size: 0.75rem; color: var(--card-color); font-weight: 700; border: 1px solid var(--card-color); padding: 2px 6px; border-radius: 4px;">
                                                ÂΩìÂâçÈÄâ‰∏≠</div>
                                        </div>
                                        <div class="advice-desc">Ë∂ÖÈ¢ùÊî∂ÁõäÁ™ÅÂá∫ÔºåÈÄÇÂêàËøõÊîªÂûãÊäïËµÑËÄÖ</div>
                                        <div class="advice-arrow">Êü•ÁúãËØ¶ÊÉÖ ‚Üí</div>
                                    </div>
                                    <!-- Long Term -->
                                    <div class="advice-card" :class="{active: recTab === 'long_term'}"
                                        style="--card-color: #45B7D1" @click="recTab='long_term'">
                                        <div class="advice-header">
                                            <div class="advice-title"><span style="font-size:1.2rem">‚è≥</span> ÈïøÁ∫øÊåÅÊúâ</div>
                                            <div v-if="recTab === 'long_term'"
                                                style="font-size: 0.75rem; color: var(--card-color); font-weight: 700; border: 1px solid var(--card-color); padding: 2px 6px; border-radius: 4px;">
                                                ÂΩìÂâçÈÄâ‰∏≠</div>
                                        </div>
                                        <div class="advice-desc">Â§èÊôÆÊØîÁéáÈ´ò‰∏îÂõûÊí§ÊéßÂà∂Â•ΩÔºåÈÄÇÂêàÈïøÊúüÈÖçÁΩÆ</div>
                                        <div class="advice-arrow">Êü•ÁúãËØ¶ÊÉÖ ‚Üí</div>
                                    </div>
                                    <!-- Defensive -->
                                    <div class="advice-card" :class="{active: recTab === 'low_beta'}"
                                        style="--card-color: #96CEB4" @click="recTab='low_beta'">
                                        <div class="advice-header">
                                            <div class="advice-title"><span style="font-size:1.2rem">üõ°Ô∏è</span> Á®≥ÂÅ•Èò≤ÂÆà
                                            </div>
                                            <div v-if="recTab === 'low_beta'"
                                                style="font-size: 0.75rem; color: var(--card-color); font-weight: 700; border: 1px solid var(--card-color); padding: 2px 6px; border-radius: 4px;">
                                                ÂΩìÂâçÈÄâ‰∏≠</div>
                                        </div>
                                        <div class="advice-desc">Ê≥¢Âä®ÂíåÂõûÊí§ÈÉΩËæÉ‰ΩéÔºåÈÄÇÂêàÁ®≥ÂÅ•ÂûãÊäïËµÑËÄÖ</div>
                                        <div class="advice-arrow">Êü•ÁúãËØ¶ÊÉÖ ‚Üí</div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
        </div>

        <!-- 2. Core Metrics Cards -->




        <!-- 4. Fund List Results -->
        <div class="glass-card">
            <div class="section-header">
                <h2 class="section-title">üìã Êé®ËçêÂàóË°®</h2>
                <div style="font-size: 0.9rem; color: var(--text-muted);">ÂÖ±Á≠õÈÄâÂá∫ {{ currentList.length }}
                    Âè™‰ºòË¥®Ê†áÁöÑ</div>
            </div>

            <div v-if="loading" style="padding: 4rem; text-align: center;">
                <div class="spinner-pro" style="margin: 0 auto 1rem;"></div>
                <p style="color: var(--text-muted);">Ê≠£Âú®ËÆ°ÁÆó‰ºòÈÄâÊñπÊ°à...</p>
            </div>

            <div v-else-if="currentList && currentList.length" class="item-list">
                <div v-for="fund in currentList" :key="fund.code" class="fund-card"
                    @click="analyzeFundByCode(fund.code)">
                    <div class="fund-info-header" style="position: relative;">
                        <div style="flex: 1; overflow: hidden;">
                            <div class="fund-name"
                                style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                {{ fund.name }}
                            </div>
                            <div class="fund-code">{{ fund.code }}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                            <div class="score-pill" :class="getScoreClass(fund.grade)">
                                {{ fund.score }} ÂàÜ
                            </div>
                            <div @click.stop="toggleCompare(fund)" class="score-pill"
                                style="font-size: 0.65rem; padding: 2px 8px; cursor: pointer; border: 1px solid var(--primary);"
                                :style="{background: compareList.some(f => f.code === fund.code) ? 'var(--primary)' : 'transparent', color: compareList.some(f => f.code === fund.code) ? 'white' : 'var(--text-muted)'}">
                                {{ compareList.some(f => f.code === fund.code) ? '‚úì Â∑≤ÂÖ•PKÊ†è' : 'ü•á PKÂØπÊØî'
                                }}
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <span class="score-pill"
                            style="background: rgba(243, 156, 18, 0.1); color: var(--primary); font-size: 0.75rem;">
                            {{ fund.invest_type }}
                        </span>
                    </div>
                    <div class="metrics-row" style="grid-template-columns: 1fr 1fr;">
                        <div class="metric-card"
                            style="padding: 0.75rem; border: none; background: rgba(255,255,255,0.02);">
                            <div class="metric-label" style="font-size: 0.7rem;">Alpha (Ë∂ÖÈ¢ù)</div>
                            <div class="metric-value" style="font-size: 1.1rem;"
                                :class="fund.alpha > 0 ? 'text-up' : 'text-down'">
                                {{ fund.alpha }}%
                            </div>
                        </div>
                        <div class="metric-card"
                            style="padding: 0.75rem; border: none; background: rgba(255,255,255,0.02);">
                            <div class="metric-label" style="font-size: 0.7rem;">Sharpe (Â§èÊôÆ)</div>
                            <div class="metric-value" style="font-size: 1.1rem;">{{ fund.sharpe }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else style="padding: 4rem; text-align: center; color: var(--text-muted);">
                ÊöÇÊó†Êï∞ÊçÆ
            </div>
        </div>

        <!-- 5. Predictions & News (Secondary) -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 2rem;">
            <!-- Predictions -->
            <div class="glass-card">
                <h2 class="section-title" style="font-size: 1.2rem; margin-bottom: 1rem;">üöÄ ÊòéÊó•Âº∫ÂäøÈ¢ÑÂà§</h2>
                <div v-if="predictions.length" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div v-for="p in predictions.slice(0, 3)" :key="p.code" @click="analyzeFundByCode(p.code)"
                        style="background: rgba(255,255,255,0.03); padding: 0.75rem; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                        <div>
                            <div style="font-weight: 600;">{{ p.name }}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">{{ p.code }}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; color: var(--primary);">‰∏äÊ∂®Ê¶ÇÁéá</div>
                            <div style="font-weight: 800; color: var(--success);">{{ p.probability }}%
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else style="color: var(--text-muted); padding: 1rem; text-align: center;">Ê≠£Âú®ËÆ°ÁÆó...
                </div>
            </div>

            <!-- Market News -->
            <div class="glass-card">
                <h2 class="section-title" style="font-size: 1.2rem; margin-bottom: 1rem;">üì∞ ÂÆûÊó∂ÁîµÊä•</h2>
                <div v-if="marketNews.length" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div v-for="news in marketNews.slice(0, 3)" :key="news.title"
                        @click="searchQuery = news.title.slice(0, 10); handleSearch(); mode = 'search'"
                        style="background: rgba(255,255,255,0.03); padding: 0.75rem; border-radius: 8px; cursor: pointer;">
                        <div
                            style="font-size: 0.85rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            {{ news.title }}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">
                            {{ news.time || news.date }} ¬∑ {{ news.source }}</div>
                    </div>
                </div>
                <div v-else style="color: var(--text-muted); padding: 1rem; text-align: center;">ÊöÇÊó†ËµÑËÆØ
                </div>
            </div>
        </div>
        </template>

        <!-- ========== Âü∫ÈáëÈ¢ëÈÅì ========== -->
        <template v-if="mode === 'channel'">
            <!-- 1. Market Hotspots -->
            <div class="glass-card" style="margin-bottom: 2rem; padding: 2rem;">
                <div class="section-title"
                    style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span>üî• Â∏ÇÂú∫ÁÉ≠ÁÇπÈÄèËßÜ</span>
                        <div v-if="marketHotspots.sentiment" class="sentiment-pill"
                            :class="'pill-' + marketHotspots.sentiment.fear_greed.toLowerCase().replace(' ', '-')">
                            {{ marketHotspots.sentiment.fear_greed }} ({{ marketHotspots.sentiment.score }})
                        </div>
                    </div>
                    <span class="score-pill"
                        style="font-size: 0.8rem; background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3);">AI
                        ÂÆûÊó∂ËÅöÂêà</span>
                </div>

                <div v-if="marketHotspots.sentiment?.breadth && marketHotspots.sentiment.breadth.total > 0"
                    style="margin: 1rem 0;">
                    <div
                        style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 4px; color: var(--text-muted);">
                        <span>‰∏äÊ∂®: {{ marketHotspots.sentiment.breadth.up }}</span>
                        <span>‰∏ãË∑å: {{ marketHotspots.sentiment.breadth.down }}</span>
                    </div>
                    <div class="breadth-bar">
                        <div class="breadth-up" :style="{width: marketHotspots.sentiment.breadth.up_ratio + '%'}"></div>
                        <div class="breadth-down"
                            :style="{width: (100 - marketHotspots.sentiment.breadth.up_ratio) + '%'}">
                        </div>
                    </div>
                </div>

                <div v-if="loadingHotspots" style="padding: 2rem; text-align: center;">
                    <div class="spinner-pro" style="margin: 0 auto 1rem;"></div>
                    <p style="color: var(--text-muted);">Ê≠£Âú®ÂàÜÊûêÂÖ®Â∏ÇÂú∫Êñ∞ÈóªÊ≥¢ÊÆµ...</p>
                </div>
                <div v-else style="margin-top: 1.5rem;">
                    <div v-for="(item, index) in (marketHotspots.hotspots || [])" :key="index" class="hotspot-card">
                        <div class="hotspot-title">
                            <span style="color: var(--primary); opacity: 0.8;">{{ index + 1 }}.</span>
                            {{ item.title }}
                        </div>

                        <!-- Block 1: What Happened -->
                        <div class="hotspot-section">
                            <div class="hotspot-label">ÂèëÁîü‰∫Ü‰ªÄ‰πà</div>
                            <p class="hotspot-content">{{ item.what_happened }}</p>
                        </div>

                        <!-- Block 2: Sectors -->
                        <div class="hotspot-section">
                            <div class="hotspot-label">Ê∂âÂèäÊùøÂùó</div>
                            <div class="hotspot-tags" v-if="item.sectors && item.sectors.length">
                                <span v-for="tag in item.sectors" :key="tag" class="hotspot-tag"
                                    @click="window.appSearch(tag)">
                                    {{ tag }}
                                </span>
                            </div>
                            <p v-else class="hotspot-content" style="opacity: 0.5;">ÊöÇÊó†ÊòéÁ°ÆÊùøÂùó</p>
                        </div>

                        <!-- Block 3: Comment -->
                        <div class="hotspot-section" style="margin-bottom: 0;">
                            <div class="hotspot-label">ÁÆÄËØÑ</div>
                            <div class="hotspot-comment">
                                <p class="hotspot-content">{{ item.comment }}</p>
                            </div>
                        </div>
                    </div>

                    <div v-if="!marketHotspots.hotspots || marketHotspots.hotspots.length === 0"
                        style="color: var(--text-muted); text-align: center; padding: 2rem;">
                        ÊöÇÊó†Ê∑±Â∫¶ÁÉ≠ÁÇπËß£Êûê
                    </div>
                </div>
            </div>

            <!-- 2. Hot Sectors -->
            <div style="margin-bottom: 2rem;">
                <div class="section-title">
                    <span>üìä ÁÉ≠Èó®Ë°å‰∏öÊùøÂùó</span>
                </div>
                <div v-if="loadingSectors" style="padding: 2rem; text-align: center;">
                    <div class="spinner-pro" style="margin: 0 auto;"></div>
                </div>
                <div v-else class="sector-scroll-container">
                    <div v-for="sector in hotSectors" :key="sector.sector" class="glass-card sector-mini-card"
                        @click="openSectorDetail(sector.sector)">
                        <div class="sector-icon">{{ getSectorIcon(sector.sector) }}</div>
                        <div class="sector-info">
                            <div class="sector-name">{{ sector.sector }}</div>
                            <div class="sector-gain" :class="sector.avg_return >= 0 ? 'text-up' : 'text-down'">
                                {{ sector.avg_return >= 0 ? '+' : '' }}{{ (sector.avg_return || 0).toFixed(2) }}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Ranking Hub -->
            <div class="glass-card" style="margin-bottom: 3rem;">
                <div class="section-header-flex">
                    <h2 class="section-title" style="margin: 0; display: flex; align-items: center; gap: 1rem;">
                        üìã Âü∫ÈáëÊ¶úÂçï‰∏≠ÂøÉ
                        <button class="pro-btn" @click="showFilterDrawer = true"
                            style="font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.3);">
                            ‚öôÔ∏è Á≠õÈÄâ
                        </button>
                    </h2>
                    <div class="ranking-tabs">
                        <div class="ranking-tab" :class="{active: rankTab === 'score'}" @click="fetchRankings('score')">
                            ÁªºÂêà‰ºòÈÄâ</div>
                        <div class="ranking-tab" :class="{active: rankTab === 'return_1y'}"
                            @click="fetchRankings('return_1y')">Âπ¥ÂåñÊî∂Áõä</div>
                        <div class="ranking-tab" :class="{active: rankTab === 'sharpe'}"
                            @click="fetchRankings('sharpe')">Á®≥ÂÅ•ÂÖàÈîã</div>
                        <div class="ranking-tab" :class="{active: rankTab === 'alpha'}" @click="fetchRankings('alpha')">
                            Ë∂ÖÈ¢ùËøõÊîª</div>
                        <div class="ranking-tab" :class="{active: rankTab === 'max_drawdown'}"
                            @click="fetchRankings('max_drawdown')">ÂõûÊí§ÊéßÂà∂</div>
                    </div>
                </div>

                <div v-if="loadingRankings" style="padding: 4rem; text-align: center;">
                    <div class="spinner-pro" style="margin: 0 auto 1rem;"></div>
                    <p style="color: var(--text-muted);">Ê≠£Âú®ÂÆûÊó∂ËÆ°ÁÆóÂÖ®Â∏ÇÂú∫ÊéíË°å...</p>
                </div>
                <div v-else class="item-list">
                    <div v-for="(fund, index) in rankingListData" :key="fund.code" class="fund-card"
                        @click="analyzeFundByCode(fund.code)">
                        <div class="fund-info-header" style="margin-bottom: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div class="rank-badge" :class="'rank-' + (index + 1)" v-if="index < 3">{{ index + 1 }}
                                </div>
                                <div class="rank-badge" v-else>{{ index + 1 }}</div>
                                <div>
                                    <div class="fund-name" style="font-size: 1rem;">{{ fund.name }}</div>
                                    <div class="fund-code">{{ fund.code }}</div>
                                </div>
                            </div>
                            <div class="score-pill" :class="getScoreClass(fund.grade)">{{ fund.grade }}</div>
                        </div>
                        <div class="core-metrics-grid" style="margin-bottom: 1rem;">
                            <div class="metric-card"
                                style="padding: 0.75rem; border: none; background: rgba(255,255,255,0.02);">
                                <div class="metric-label" style="font-size: 0.7rem;">ÊúÄÊñ∞ÂáÄÂÄº ({{ fund.nav_date }})</div>
                                <div class="metric-value" style="font-size: 1.1rem;">{{ fund.nav || '--' }}</div>
                            </div>
                            <div class="metric-card"
                                style="padding: 0.75rem; border: none; background: rgba(255,255,255,0.02);">
                                <div class="metric-label" style="font-size: 0.7rem;">Êó•Ê∂®Ë∑åÂπÖ</div>
                                <div class="metric-value" style="font-size: 1.1rem;"
                                    :class="fund.change_percent >= 0 ? 'text-up' : 'text-down'">
                                    {{ fund.change_percent >= 0 ? '+' : '' }}{{ fund.change_percent }}%
                                </div>
                            </div>
                            <div class="metric-card"
                                style="padding: 0.75rem; border: none; background: rgba(255,255,255,0.02);">
                                <div class="metric-label" style="font-size: 0.7rem;">{{ rankTab === 'score' ? 'ÁªºÂêàËØÑÂàÜ' :
                                    (rankTab === 'sharpe' ? 'Â§èÊôÆÊØîÁéá' : (rankTab === 'max_drawdown' ? 'ÊúÄÂ§ßÂõûÊµã' : 'Ë°®Áé∞ÊåáÊ†á')) }}
                                </div>
                                <div class="metric-value" style="font-size: 1.1rem; color: var(--primary);">
                                    {{ rankTab === 'score' ? fund.score : (rankTab === 'max_drawdown' ?
                                    fund.max_drawdown + '%' : fund[rankTab]) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- ========== Ê∂®ÂπÖÊ¶úÂçï ========== -->
        <template v-if="mode === 'gainers'">
            <div class="glass-card">
                <div class="section-header">
                    <h2 class="section-title">üìà Ê∂®ÂπÖÊ¶úÂçï</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button v-for="p in gainerPeriods" :key="p.value" class="pro-btn"
                            :style="{padding: '0.4rem 0.8rem', fontSize: '0.8rem', background: gainerPeriod === p.value ? '' : 'rgba(255,255,255,0.05)', opacity: gainerPeriod === p.value ? 1 : 0.7}"
                            @click="gainerPeriod = p.value; fetchTopGainers()">
                            {{ p.label }}
                        </button>
                    </div>
                </div>

                <div v-if="gainerLoading" style="padding: 4rem; text-align: center;">
                    <div class="spinner-pro" style="margin: 0 auto 1rem;"></div>
                    <p style="color: var(--text-muted);">Ëé∑ÂèñÊ¶úÂçï‰∏≠...</p>
                </div>

                <div v-else-if="topGainers.length" class="item-list">
                    <div v-for="(fund, idx) in topGainers" :key="fund.code" class="fund-card"
                        @click="analyzeFundByCode(fund.code)">
                        <div class="fund-info-header" style="align-items: center;">
                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                                <div class="rank-badge" :class="'rank-' + (idx + 1)">{{ idx + 1 }}</div>
                                <div>
                                    <div class="fund-name">{{ fund.name }}</div>
                                    <div class="fund-code">{{ fund.code }}</div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                                <div class="metric-value font-up" style="font-size: 1.25rem;">
                                    +{{ fund.gain }}%
                                </div>
                                <div @click.stop="toggleCompare(fund)" class="score-pill"
                                    style="font-size: 0.65rem; padding: 2px 8px; cursor: pointer; border: 1px solid var(--primary);"
                                    :style="{background: compareList.some(f => f.code === fund.code) ? 'var(--primary)' : 'transparent', color: compareList.some(f => f.code === fund.code) ? 'white' : 'var(--text-muted)'}">
                                    PK
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <span class="score-pill"
                                style="background: rgba(255,255,255,0.05); color: var(--text-muted); font-size: 0.7rem; padding: 2px 6px;">{{
                                fund.type }}</span>
                        </div>
                    </div>
                </div>
                <div v-else style="padding: 5rem; text-align: center; color: var(--text-muted);">
                    ÊöÇÊó†Êï∞ÊçÆÔºåËØ∑Âà∑Êñ∞ÈáçËØï
                </div>
            </div>
        </template>

        <!-- ========== Sector Deep Dive Modal ========== -->
        <div v-if="showSectorModal" class="modal-overlay" @click.self="showSectorModal = false">
            <div class="sector-modal-content">
                <div class="section-header" style="padding: 1.5rem; border-bottom: 1px solid var(--glass-border);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 2rem;">{{ getSectorIcon(selectedSector) }}</span>
                        <div>
                            <h2 class="section-title" style="margin: 0; font-size: 1.5rem;">{{ selectedSector }} ÊùøÂùóÊ∑±Â∫¶Ê¥ûÂØü
                            </h2>
                            <div v-if="sectorDetail?.sentiment" class="sentiment-pill"
                                :class="'pill-' + sectorDetail.sentiment.sentiment.toLowerCase().replace(' ', '-')">
                                ÊùøÂùóÊÉÖÁª™: {{ sectorDetail.sentiment.sentiment }} ({{
                                (sectorDetail.sentiment.ratio*100).toFixed(0) }}% È¢ÜÊ∂®)
                            </div>
                        </div>
                    </div>
                    <button class="pro-btn" style="padding: 0.5rem; background: transparent;"
                        @click="showSectorModal = false">‚úï</button>
                </div>

                <div v-if="loadingSectorDetail" style="padding: 5rem; text-align: center;">
                    <div class="spinner-pro" style="margin: 0 auto 1rem;"></div>
                    <p style="color: var(--text-muted);">Ê≠£Âú®ËÅöÂêàÊùøÂùóÊúÄÊñ∞Âä®Âêë‰∏é AI È¢ÑÊµã...</p>
                </div>

                <div v-else-if="sectorDetail" style="padding: 2rem;">
                    <!-- 1. Prediction Banner -->
                    <div class="glass-card"
                        style="border: 1px solid #FFD700; background: rgba(255, 215, 0, 0.05); margin-bottom: 2rem; padding: 1.5rem;">
                        <div
                            style="display: flex; align-items: center; gap: 0.75rem; color: #FFD700; font-weight: 700;">
                            <span>üîÆ AI Êú™Êù•Â±ïÊúõ (1d/1w)</span>
                        </div>
                        <div class="markdown-content" style="margin-top: 1rem;"
                            v-html="renderMarkdown(sectorDetail.prediction.prediction)"></div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <!-- Left: Metrics -->
                        <div class="sector-modal-card">
                            <h3 class="section-title" style="font-size: 1rem; margin-bottom: 1.25rem;">Ê†∏ÂøÉË°®Áé∞</h3>
                            <div class="stats-grid" style="grid-template-columns: 1fr; gap: 1rem;">
                                <div class="data-card" style="display: flex; justify-content: space-between;">
                                    <span class="data-label">Ëøë1Âπ¥Êî∂ÁõäÁéá</span>
                                    <span class="data-number" style="font-size: 1.25rem;"
                                        :class="sectorDetail.metrics.metrics?.avg_return_1y >= 0 ? 'text-up' : 'text-down'">
                                        {{ (sectorDetail.metrics.metrics?.avg_return_1y || 0).toFixed(2) }}%
                                    </span>
                                </div>
                                <div class="data-card" style="display: flex; justify-content: space-between;">
                                    <span class="data-label">Âπ≥ÂùáÂ§èÊôÆÊØîÁéá</span>
                                    <span class="data-number" style="font-size: 1.25rem; color: var(--primary);">
                                        {{ (sectorDetail.metrics.metrics?.avg_sharpe || 0).toFixed(2) }}
                                    </span>
                                </div>
                                <div class="data-card" style="display: flex; justify-content: space-between;">
                                    <span class="data-label">Âπ≥ÂùáÂõûÊí§</span>
                                    <span class="data-number" style="font-size: 1.25rem; color: var(--accent);">
                                        {{ (sectorDetail.metrics.metrics?.avg_drawdown || 0).toFixed(2) }}%
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Top Funds -->
                        <div class="sector-modal-card">
                            <h3 class="section-title" style="font-size: 1rem; margin-bottom: 1.25rem;">ÊùøÂùóÈ¢ÜÊ∂®Ê†áÁöÑ</h3>
                            <div class="item-list">
                                <div v-for="fund in sectorDetail.metrics.top_funds || []" :key="fund.code"
                                    class="fund-card" style="padding: 0.75rem;" @click="analyzeFundByCode(fund.code)">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="font-size: 0.9rem; font-weight: 600;">{{ fund.name }}</div>
                                        <div class="text-up" style="font-family: 'Outfit'; font-weight: 700;">+{{
                                            fund.return_1y || 0 }}%</div>
                                    </div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">{{ fund.code }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 2rem; text-align: center;">
                        <button class="pro-btn" style="padding: 0.75rem 2rem;" @click="searchByTheme(selectedSector)">
                            üîç Âú®Ê∑±Â∫¶ÊêúÁ¥¢‰∏≠Êü•ÁúãÊõ¥Â§ö {{ selectedSector }} Âü∫Èáë
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== Fund Deep Dive Overlay ========== -->
        <transition name="fade">
            <div v-if="fundDetail" class="deep-dive-overlay">
                <button class="close-btn" @click="closeFundDetail">
                    <i data-lucide="x"></i>
                </button>

                <div style="max-width: 1000px; margin: 0 auto; padding-top: 2rem;">
                    <!-- Header -->
                    <div style="margin-bottom: 2rem;">
                        <div
                            style="display: flex; gap: 1rem; align-items: center; margin-bottom: 0.5rem; position: relative;">
                            <h1 style="font-size: 2rem; font-weight: 700; margin: 0;">{{ fundDetail.name }}</h1>

                            <!-- Status Badges -->
                            <div style="display: flex; gap: 0.25rem;">
                                <span v-if="fundDetail.score > 85" class="status-badge badge-hot">üî• ÁÉ≠Èó®</span>
                                <span v-if="parseFloat(fundDetail.metrics?.max_drawdown) < 10"
                                    class="status-badge badge-steady">üíé Á®≥ÂÅ•</span>
                                <span v-if="fundDetail.grade && fundDetail.grade.includes('D')"
                                    class="status-badge badge-warning">‚ö†Ô∏è È£éÊ†ºÊºÇÁßª</span>
                            </div>

                            <div style="position: relative;">
                                <span class="score-pill" :class="getScoreClass(fundDetail.grade)"
                                    @click="showRadar = !showRadar" style="cursor: pointer; position: relative;">
                                    {{ fundDetail.score }}ÂàÜ
                                    <span style="font-size: 0.7rem; margin-left: 4px; opacity: 0.7;">‚ìò</span>
                                </span>

                                <!-- Radar Chart Overlay -->
                                <div v-if="showRadar" class="radar-overlay" @click.stop>
                                    <div
                                        style="font-weight: 700; margin-bottom: 1rem; border-bottom: 1px solid var(--white-10); padding-bottom: 0.5rem;">
                                        ‰∫îÁª¥ËÉΩÂäõÈÄèËßÜ</div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                        <div v-for="(val, key) in fundDetail.radar_data || defaultRadar" :key="key">
                                            <div class="radar-label">{{ key }}</div>
                                            <div class="radar-value">{{ val }}</div>
                                            <div class="rank-bar-container" style="height: 3px;">
                                                <div class="rank-bar-fill" :style="{width: val + '%'}"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        style="margin-top: 1rem; font-size: 0.7rem; color: var(--text-muted); line-height: 1.4;">
                                        * Âü∫‰∫éËøë1Âπ¥Êî∂ÁõäÂéÜ„ÄÅÊäóË∑åÂäõ„ÄÅÊÄß‰ª∑ÊØîÂèäÁªèÁêÜËøáÂæÄË°®Áé∞ÁªºÂêàËÆ°ÁÆó„ÄÇ
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                            <span>{{ fundDetail.code }}</span>
                            <span>{{ fundDetail.type }}</span>
                            <span>È£éÈô©Á≠âÁ∫ß: {{ fundDetail.risk_level || '‰∏≠È£éÈô©' }}</span>
                        </div>

                        <div style="display: flex; gap: 3rem; margin-top: 1.5rem;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                                    {{ fundDetail.metrics?.estimation_nav ? '‰ªäÊó•‰º∞ÂÄº' : 'ÊúÄÊñ∞ÂáÄÂÄº' }} ({{
                                    fundDetail.metrics?.realtime_time ? fundDetail.metrics?.realtime_time :
                                    fundDetail.metrics?.nav_date }})
                                </div>
                                <div
                                    style="font-size: 2.5rem; font-weight: 700; font-family: 'Outfit'; position: relative;">
                                    {{ fundDetail.metrics?.estimation_nav || fundDetail.metrics?.nav || '--' }}
                                    <span v-if="fundDetail.metrics?.estimation_nav" class="realtime-badge">ÂÆûÊó∂</span>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                                    Êó•Ê∂®Ë∑åÂπÖ {{ fundDetail.metrics?.estimation_growth ? '(‰º∞ÁÆó)' : '' }}
                                </div>
                                <div style="font-size: 2.5rem; font-weight: 700; font-family: 'Outfit';"
                                    :class="(fundDetail.metrics?.estimation_growth || fundDetail.metrics?.change_percent || 0) >= 0 ? 'text-up' : 'text-down'">
                                    {{ (fundDetail.metrics?.estimation_growth || fundDetail.metrics?.change_percent) >=
                                    0 ? '+' : '' }}{{
                                    fundDetail.metrics?.estimation_growth || fundDetail.metrics?.change_percent }}%
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="detail-tabs">
                        <div class="detail-tab" :class="{active: activeFundTab==='brief'}"
                            @click="activeFundTab='brief'">
                            Âü∫ÈáëÁÆÄÂÜµ</div>
                        <div class="detail-tab" :class="{active: activeFundTab==='holdings'}"
                            @click="activeFundTab='holdings'">ÊåÅ‰ªìÂàÜÊûê</div>
                        <div class="detail-tab" :class="{active: activeFundTab==='news'}" @click="activeFundTab='news'">
                            ÂÖ¨ÂëäËµÑËÆØ
                        </div>
                    </div>

                    <!-- Tab Content: Brief -->
                    <div v-if="activeFundTab==='brief'">
                        <!-- v4.0 Analysis Cards (Horizontal Scroll) -->
                        <div v-if="fundDetail.ai_v4_analysis" class="analysis-cards-container"
                            style="margin-bottom: 2rem;">
                            <!-- Summary Card -->
                            <div class="analysis-card" style="border-left: 4px solid var(--primary);">
                                <div class="card-title">{{ fundDetail.ai_v4_analysis.summary_card?.title ||
                                    'Á≠ñÁï•Âü∫Ë∞É'
                                    }}</div>
                                <div class="card-subtitle">{{ fundDetail.ai_v4_analysis.summary_card?.verdict }}
                                </div>
                                <div style="display: flex; gap: 0.25rem; flex-wrap: wrap; margin-top: 0.5rem;">
                                    <span v-for="tag in fundDetail.ai_v4_analysis.summary_card?.tags" :key="tag"
                                        class="score-pill"
                                        style="font-size: 0.7rem; padding: 2px 6px; background: rgba(99,102,241,0.1); color: var(--primary);">
                                        #{{ tag }}
                                    </span>
                                </div>
                                <div class="card-footer">Êï∞ÊçÆÊ∫ê: {{
                                    fundDetail.ai_v4_analysis.summary_card?.citation
                                    }}</div>
                            </div>

                            <!-- Attribution Card -->
                            <div class="analysis-card">
                                <div class="card-title">{{ fundDetail.ai_v4_analysis.attribution_card?.title ||
                                    '‰∏öÁª©ÂΩíÂõ†' }}</div>
                                <div class="points-list">
                                    <div v-for="(p, i) in fundDetail.ai_v4_analysis.attribution_card?.points" :key="i"
                                        class="point-item">
                                        <span class="dot"
                                            :style="{background: p.impact.includes('‰∏ã') || p.impact.includes('-') ? 'var(--accent)' : 'var(--success)'}"></span>
                                        <div style="display: flex; flex-direction: column;">
                                            <span style="font-weight: 600;">{{ p.reason }}</span>
                                            <span style="font-size: 0.75rem; color: var(--text-muted);">{{
                                                p.impact }} ({{ p.source }})</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Stress Test Card -->
                            <div class="analysis-card">
                                <div class="card-title">ÂéãÂäõÊµãËØï (If HS300 -10%)</div>
                                <div class="stress-value text-down">
                                    -{{ (fundDetail.metrics?.beta * 10 || 1.25 * 10).toFixed(1) }}%
                                </div>
                                <div class="card-footer">
                                    {{ fundDetail.v4_analysis.stress_test?.beta_ref || 'Âü∫‰∫éÂéÜÂè≤ Beta ÂÄºËÆ°ÁÆó' }}
                                </div>
                            </div>
                        </div>

                        <!-- Default AI Banner if no v4 analysis yet -->
                        <div v-else class="glass-card ai-banner" style="margin-bottom: 2rem;">
                            <h3
                                style="font-size: 1.2rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                ü§ñ AI Ê∑±Â∫¶ÁÇπËØÑ
                            </h3>
                            <div v-if="fundDetail.ai_analysis" class="ai-content"
                                v-html="renderAIContent(fundDetail.ai_analysis)"></div>
                            <div v-else style="color: var(--text-muted); padding: 1rem;">
                                <div class="spinner-pro"
                                    style="display: inline-block; margin-right: 0.5rem; vertical-align: middle;">
                                </div>
                                Ê≠£Âú®ÁîüÊàêÁªìÊûÑÂåñÂàÜÊûê...
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                            <!-- Left: Performance & Charts -->
                            <div>
                                <!-- Price Chart with Crash Markers -->
                                <div class="glass-card" style="margin-bottom: 2rem; padding: 1.5rem;">
                                    <div
                                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                        <h3 class="section-title" style="font-size: 1.1rem; margin: 0;">‰ª∑Ê†ºËµ∞Âäø &
                                            ÂéÜÂè≤ÂéãÂäõÊµãËØï</h3>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">
                                            <span
                                                style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #ef4444; margin-right: 4px;"></span>
                                            ÂÖ≥ÈîÆÂéãÂäõ
                                            <span
                                                style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #10b981; margin-left: 8px; margin-right: 4px;"></span>
                                            Êú∫‰ºöÁÇπ
                                        </div>
                                    </div>
                                    <div
                                        style="position: relative; width: 100%; height: 220px; background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden;">
                                        <svg width="100%" height="200" viewBox="0 0 800 200" preserveAspectRatio="none">
                                            <path :d="chartPath" fill="none" stroke="var(--primary)" stroke-width="2"
                                                vector-effect="non-scaling-stroke" />

                                            <!-- Crash Markers -->
                                            <g v-for="marker in crashMarkers" :key="marker.date">
                                                <line :x1="marker.x" y1="0" :x2="marker.x" y2="200"
                                                    :stroke="marker.color" stroke-dasharray="4,4" opacity="0.4" />
                                                <circle :cx="marker.x" :cy="marker.y" r="4" :fill="marker.color" />
                                                <rect :x="marker.x - 40"
                                                    :y="marker.y < 50 ? marker.y + 10 : marker.y - 25" width="80"
                                                    height="18" rx="4" fill="rgba(15,23,42,0.8)" />
                                                <text :x="marker.x" :y="marker.y < 50 ? marker.y + 22 : marker.y - 12"
                                                    text-anchor="middle" font-size="10" fill="white">{{
                                                    marker.label }}</text>
                                            </g>
                                        </svg>
                                        <div
                                            style="position: absolute; bottom: 5px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 10px; font-size: 0.7rem; color: var(--text-muted); opacity: 0.6;">
                                            <span>{{ fundDetail.history_nav?.[0]?.date }}</span>
                                            <span>{{ fundDetail.history_nav?.[fundDetail.history_nav.length -
                                                1]?.date }}</span>
                                        </div>
                                    </div>
                                    <div v-if="fundDetail.ai_v4_analysis?.stress_test"
                                        style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                                        üõ°Ô∏è **V4 ÂéãÂäõÊµãËØï (AI)**Ôºö{{ fundDetail.ai_v4_analysis.stress_test.prediction
                                        }}
                                        <i>{{ fundDetail.ai_v4_analysis.stress_test.beta_ref }}</i>
                                    </div>
                                    <div v-else
                                        style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                                        üí° **ÂõûÊí§‰øÆÂ§çËÉΩÂäõÂàÜÊûê**ÔºöËØ•Âü∫ÈáëÂú®ÊúÄËøëÂ§ßÂõûË∞É‰∏≠Ë°®Áé∞Á®≥ÂÅ•Ôºå‰øÆÂ§çÂ§©Êï∞‰ºò‰∫éÂêåÁ±ª‰∫ßÂìÅ„ÄÇ
                                    </div>
                                </div>

                                <div class="glass-card" style="margin-bottom: 2rem;">
                                    <h3 class="section-title" style="font-size: 1.1rem; margin-bottom: 1rem;">
                                        Áª©‰ºòÊ¶úÂçïÊéíÂêç</h3>
                                    <table class="rank-table">
                                        <thead>
                                            <tr>
                                                <th>Êó∂Èó¥Âë®Êúü</th>
                                                <th>Êî∂ÁõäÁéá</th>
                                                <th>ÂêåÁ±ªÊéíÂêç</th>
                                                <th>ÂêåÁ±ªÂπ≥Âùá</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="rank in fundRanks" :key="rank.period">
                                                <td>{{ rank.period }}</td>
                                                <td :class="parseFloat(rank.percent) > 0 ? 'text-up' : 'text-down'">
                                                    {{ rank.percent }}%
                                                </td>
                                                <td>
                                                    {{ rank.rank }}
                                                    <div class="rank-bar-container">
                                                        <div class="rank-bar-fill"
                                                            :style="{width: `${100 - (parseInt(rank.rank.split('/')[0]) / parseInt(rank.rank.split('/')[1]) * 100 || 50)}%`}">
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>{{ rank.peer_avg || '--' }}%</td>
                                            </tr>
                                            <!-- Fallback if no ranks -->
                                            <tr v-if="!fundRanks.length">
                                                <td>Ëøë1Âπ¥</td>
                                                <td
                                                    :class="fundDetail.metrics?.return_1y > 0 ? 'text-up' : 'text-down'">
                                                    {{ fundDetail.metrics?.return_1y }}%
                                                </td>
                                                <td>--/--</td>
                                                <td>--</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- DCA Time Machine -->
                                <div class="glass-card dca-panel" :class="{'dca-active': showDca}">
                                    <div class="dca-switch" @click="showDca = !showDca; if(showDca) runDcaSimulation()">
                                        <div class="toggle-track">
                                            <div class="toggle-thumb"></div>
                                        </div>
                                        <span style="font-weight: 700;">ÂºÄÂêØ‚ÄúÊó∂ÂÖâÊú∫‚ÄùÊ®°ÊãüÂÆöÊäï</span>
                                    </div>
                                    <div v-if="showDca && dcaResults"
                                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; animation: fadeIn 0.4s;">
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--text-muted);">Á¥ØËÆ°ÊäïÂÖ•
                                                (ÊØèÂë®1000)</div>
                                            <div style="font-size: 1.25rem; font-weight: 700;">¬•{{
                                                dcaResults.totalInvested.toLocaleString() }}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--text-muted);">ÂÆöÊäïÊî∂ÁõäÁéá
                                            </div>
                                            <div style="font-size: 1.5rem; font-weight: 800;"
                                                :class="parseFloat(dcaResults.yield) >= 0 ? 'text-up' : 'text-down'">
                                                {{ parseFloat(dcaResults.yield) >= 0 ? '+' : '' }}{{
                                                dcaResults.yield }}%
                                            </div>
                                        </div>
                                        <div
                                            style="grid-column: span 2; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
                                            <div style="font-size: 0.85rem; color: #10b981; font-weight: 600;">
                                                AI ÂÆöÊäïÂª∫ËÆÆ</div>
                                            <div style="font-size: 0.8rem; line-height: 1.5; margin-top: 0.25rem;">
                                                Ê≠§Âü∫Èáë{{ parseFloat(dcaResults.yield) > 0 ? 'ÈÄÇÂêà' : 'ËøëÊúü' }}ÂÆöÊäïÔºåÂæÆÁ¨ëÊõ≤Á∫ø{{
                                                parseFloat(dcaResults.yield) > 10 ? 'Â∑≤ÂàùÊ≠•ÊòæÁé∞' : 'Ê≠£Âú®ÂΩ¢Êàê' }}„ÄÇ{{
                                                parseFloat(dcaResults.yield) > 15 ? 'Âª∫ËÆÆÁªßÁª≠ÊåÅÊúâ„ÄÇ' : 'ÂΩìÂâç‰ªçÊòØÂ∫ïÈÉ®Âê∏Á≠πÊúü„ÄÇ' }}
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else-if="!showDca" style="font-size: 0.85rem; color: var(--text-muted);">
                                        Á©øË∂äÂõûËøáÂéªÔºåÁúãÁúãÂ¶ÇÊûú‰Ω†‰ªé 3 Âπ¥ÂâçÂºÄÂßãÊØèÂë®ÂÆöÊäï 1000 ÂÖÉÔºåÁé∞Âú®Ëµö‰∫ÜÂ§öÂ∞ëÔºü
                                    </div>
                                </div>

                                <!-- Cost Revealer -->
                                <div class="glass-card"
                                    style="margin-top: 1.5rem; border-left: 4px solid var(--accent);">
                                    <h3 class="section-title" style="font-size: 1.1rem; margin-bottom: 1rem;">
                                        Ë¥πÁéáÂà∫ÂÆ¢ÔºöÈöêÂΩ¢ÊàêÊú¨ÊäòÁÆó</h3>
                                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                                        <div style="font-size: 0.85rem; color: var(--text-muted);">
                                            ÁÆ°ÁêÜË¥π+ÊâòÁÆ°Ë¥π+ÈîÄÂîÆÊúçÂä°Ë¥πÔºö<span style="color: var(--accent); font-weight: 700;">{{
                                                fundDetail.metrics?.fees || '1.75' }}% /Âπ¥</span></div>
                                        <div
                                            style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 12px;">
                                            <div
                                                style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                                <span style="font-size: 0.8rem;">10‰∏áÊåÅÊúâ 10 Âπ¥Ôºå‰Ω†‰∫§ÁöÑË¥πÔºö</span>
                                                <span style="font-weight: 700; color: var(--accent);">¬•{{
                                                    calculateTotalFee(100000, 10,
                                                    parseFloat(fundDetail.metrics?.fees ||
                                                    1.75)).toLocaleString(undefined, {minimumFractionDigits: 0,
                                                    maximumFractionDigits: 0}) }}</span>
                                            </div>
                                            <div class="rank-bar-container"
                                                style="height: 6px; background: rgba(255,255,255,0.05);">
                                                <div class="rank-bar-fill"
                                                    style="background: var(--accent); width: 100%;">
                                                </div>
                                            </div>
                                            <div
                                                style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                                üí° Áõ∏ÂΩì‰∫é‰Ω†Êî∂ÁõäÁöÑ <span style="color: var(--white);">15-20%</span>
                                                ÈÉΩË¢´Ë¥πÁéáÂêÉÊéâ‰∫Ü„ÄÇÂª∫ËÆÆÂÖ≥Ê≥® <span style="color: var(--primary);">ETF/CÁ±ª</span>
                                                Âü∫Èáë„ÄÇ
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Manager & Info -->
                            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                                <div class="glass-card">
                                    <h3 class="section-title" style="font-size: 1.1rem; margin-bottom: 1rem;">
                                        Âü∫ÈáëÁªèÁêÜ</h3>
                                    <div v-if="fundManager" style="display: flex; flex-direction: column; gap: 1rem;">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div class="manager-avatar">{{ fundManager.name[0] }}</div>
                                            <div>
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <div style="font-weight: 700; font-size: 1.2rem;">{{
                                                        fundManager.name }}</div>
                                                    <div v-if="fundDetail.manager_ai"
                                                        style="font-size: 0.75rem; padding: 2px 6px; background: var(--primary); color: white; border-radius: 4px; font-weight: 700;">
                                                        AIËØÑÁ∫ß {{ fundDetail.manager_ai.rating }}
                                                    </div>
                                                </div>
                                                <div style="font-size: 0.85rem; color: var(--text-muted);">{{
                                                    fundManager.company }}</div>
                                            </div>
                                        </div>
                                        <div v-if="fundDetail.manager_ai"
                                            style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                                            <span
                                                style="font-size: 0.7rem; padding: 2px 8px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                                                È£éÊ†º: {{ fundDetail.manager_ai.style }}
                                            </span>
                                            <span v-for="pro in fundDetail.manager_ai.pros" :key="pro"
                                                style="font-size: 0.7rem; padding: 2px 8px; background: rgba(99,102,241,0.1); color: var(--primary); border-radius: 12px;">
                                                {{ pro }}
                                            </span>
                                        </div>
                                        <div
                                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                                            <div>
                                                <div style="font-size: 0.8rem; color: var(--text-muted);">‰ªé‰∏öÂπ¥Èôê
                                                </div>
                                                <div style="font-weight: 600;">{{ fundManager.tenure }}</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 0.8rem; color: var(--text-muted);">ÁÆ°ÁêÜËßÑÊ®°
                                                </div>
                                                <div style="font-weight: 600;">{{ fundManager.scale }}</div>
                                            </div>
                                        </div>

                                        <!-- Manager Career Timeline -->
                                        <div style="margin-top: 1.5rem;">
                                            <div
                                                style="font-size: 0.85rem; font-weight: 700; margin-bottom: 0.75rem; color: var(--primary);">
                                                ËÅå‰∏öÁîüÊ∂ØËΩ®Ëøπ</div>
                                            <div class="manager-timeline"
                                                style="border-left: 2px dashed rgba(255,255,255,0.1); padding-left: 1rem; margin-left: 5px;">
                                                <div v-for="(item, idx) in fundManager.career || [{period: '2021-Ëá≥‰ªä', desc: 'Áé∞‰ªªËØ•Âü∫ÈáëÁªèÁêÜ'}, {period: '2018-2021', desc: 'XXÂü∫ÈáëÂÖ¨Âè∏È´òÁ∫ßÁ†îÁ©∂Âëò'}]"
                                                    :key="idx" style="position: relative; margin-bottom: 1rem;">
                                                    <div
                                                        style="position: absolute; left: -1.4rem; top: 0.2rem; width: 0.6rem; height: 0.6rem; background: var(--primary); border-radius: 50%;">
                                                    </div>
                                                    <div style="font-size: 0.75rem; color: var(--text-muted);">
                                                        {{ item.period }}</div>
                                                    <div style="font-size: 0.85rem;">{{ item.desc }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else style="color: var(--text-muted); text-align: center; padding: 1rem;">
                                        ÊöÇÊó†ÁªèÁêÜ‰ø°ÊÅØ</div>
                                </div>

                                <!-- Actions -->
                                <div class="glass-card" style="text-align: center;">
                                    <button class="pro-btn" style="width: 100%; margin-bottom: 1rem;"
                                        @click="buyFund(fundDetail.code, fundDetail.name)">
                                        üí∞ ‰π∞ÂÖ•/ÂÆöÊäï
                                    </button>
                                    <button class="pro-btn" style="width: 100%; background: rgba(255,255,255,0.1);"
                                        @click="addToWatchlist(fundDetail.code, fundDetail.name)">
                                        ‚≠êÂä†ÂÖ•Ëá™ÈÄâ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Holdings -->
                    <div v-if="activeFundTab==='holdings'">
                        <div class="glass-card">
                            <h3 class="section-title" style="font-size: 1.1rem; margin-bottom: 1rem;">ÂâçÂçÅÂ§ßÈáç‰ªìËÇ°
                            </h3>
                            <div v-if="fundDetail.metrics?.top_holdings && fundDetail.metrics.top_holdings.length"
                                class="item-list">
                                <div v-for="stock in fundDetail.metrics.top_holdings" :key="stock.code"
                                    style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600;">{{ stock.name }}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">{{ stock.code
                                            }}</div>
                                    </div>
                                    <div style="font-weight: 700;">{{ stock.ratio }}</div>
                                </div>
                            </div>
                            <div v-else style="color: var(--text-muted); padding: 2rem; text-align: center;">
                                ÊöÇÊó†ÊåÅ‰ªìÊï∞ÊçÆ</div>
                        </div>
                    </div>

                    <!-- Tab Content: News -->
                    <div v-if="activeFundTab==='news'">
                        <div class="glass-card">
                            <h3 class="section-title" style="font-size: 1.1rem; margin-bottom: 1rem;">ÂÖ¨Âëä‰∏éËµÑËÆØ</h3>
                            <div v-if="fundNews.length" class="news-list">
                                <div v-for="(item, idx) in fundNews" :key="idx" class="news-item">
                                    <div style="font-weight: 600; font-size: 1.05rem; margin-bottom: 0.5rem;">
                                        <span
                                            style="font-size: 0.8rem; padding: 2px 6px; background: rgba(99,102,241,0.2); color: var(--primary); border-radius: 4px; margin-right: 0.5rem;">
                                            {{ item.type || 'ËµÑËÆØ' }}
                                        </span>
                                        {{ item.title }}
                                    </div>
                                    <div
                                        style="font-size: 0.9rem; color: rgba(255,255,255,0.7); line-height: 1.5; margin-bottom: 0.5rem;">
                                        {{ item.summary }}
                                    </div>
                                    <div class="news-meta">
                                        <span>{{ item.date }}</span>
                                        <span>{{ item.source }}</span>
                                    </div>
                                </div>
                            </div>
                            <div v-else style="color: var(--text-muted); padding: 2rem; text-align: center;">
                                ÊöÇÊó†Áõ∏ÂÖ≥ËµÑËÆØ</div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- ========== Ê∑±Â∫¶ÊêúÁ¥¢ & Ë∂ÖÁ∫ßË∂ÖÁ∫ßÊ¶úÂçï ========== -->
        <template v-if="mode === 'search'">
            <div class="glass-card">
                <div style="margin-bottom: 1.5rem; position: relative; display: flex; gap: 1rem;">
                    <input class="pro-input" v-model="searchQuery" @input="onSearchInput" @keyup.enter="handleSearch"
                        placeholder="ËæìÂÖ•ÊèèËø∞ (Â¶Ç: ÈïøÊúüÂàÜÁ∫¢È´òÁöÑÂåªÁñóÂü∫Èáë)..." style="flex: 1;">
                    <button class="pro-btn" @click="handleDeepSearch" :disabled="searchLoading">
                        <span v-if="searchLoading" class="spinner-pro"></span>
                        <span v-else>ü§ñ Ê∑±Â∫¶ÊêúÁ¥¢</span>
                    </button>
                </div>

                <!-- Super Scanner Storefront -->
                <div
                    style="display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 1rem; margin-bottom: 1.5rem; scrollbar-width: none;">
                    <div v-for="tag in scannerTags" :key="tag.label" class="score-pill"
                        style="cursor: pointer; white-space: nowrap; background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--glass-border);"
                        @click="searchQuery = tag.query; handleDeepSearch()">
                        {{ tag.icon }} {{ tag.label }}
                    </div>
                </div>

                <div v-if="searchInterpretation"
                    style="background: rgba(99,102,241,0.1); border-left: 3px solid var(--primary); padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.9rem; color: var(--primary); line-height: 1.4;">
                    ü§ñ <b>AI Ëß£ÊûêÔºö</b>{{ searchInterpretation }}
                </div>

                <div v-if="searchResults.length" class="item-list">
                    <div v-for="item in searchResults" :key="item.code" class="fund-card"
                        @click="analyzeFundByCode(item.code)">
                        <div class="fund-info-header">
                            <div style="flex: 1;">
                                <div class="fund-name">{{ item.name }}</div>
                                <div class="fund-code">{{ item.code }}</div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                                <div v-if="item.return_1y" style="text-align: right;">
                                    <div :class="item.return_1y >= 0 ? 'font-up' : 'font-down'"
                                        style="font-weight: 700;">
                                        {{ item.return_1y >= 0 ? '+' : '' }}{{ item.return_1y }}%
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Ëøë1Âπ¥</div>
                                </div>
                                <div @click.stop="toggleCompare(item)" class="score-pill"
                                    style="font-size: 0.65rem; padding: 2px 8px; cursor: pointer; border: 1px solid var(--primary);"
                                    :style="{background: compareList.some(f => f.code === item.code) ? 'var(--primary)' : 'transparent', color: compareList.some(f => f.code === item.code) ? 'white' : 'var(--text-muted)'}">
                                    PK
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <span v-for="t in (item.themes || [])" :key="t" class="score-pill"
                                style="font-size: 0.7rem; padding: 2px 6px; background: rgba(255,255,255,0.05);">{{
                                t }}</span>
                        </div>
                    </div>
                </div>

                <div v-else-if="!searchLoading" style="padding: 5rem; text-align: center; color: var(--text-muted);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                    <div v-if="searchInterpretation" style="margin-bottom: 1rem; color: #fbbf24;">
                        <p>AI Â∑≤‰∏∫ÊÇ®Á≠õÈÄâÔºö{{ searchInterpretation }}</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.8;">(ÊöÇÊó†ÂåπÈÖçÂü∫ÈáëÔºåËØ∑Â∞ùËØïÊîæÂÆΩÊù°‰ª∂)</p>
                    </div>
                    <p v-else-if="searchQuery.trim().length >= 2">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÂü∫ÈáëÔºåËØ∑Â∞ùËØïÁÇπÂáª <b>ü§ñ Ê∑±Â∫¶ÊêúÁ¥¢</b></p>
                    <p v-else>ËæìÂÖ•ÂÖ≥ÈîÆËØçÊàñ‰ΩøÁî® <b>ü§ñ Ê∑±Â∫¶ÊêúÁ¥¢</b> ÂØªÊâæ‰ºòË¥®Âü∫Èáë</p>
                </div>

                <div v-if="searchLoading" style="padding: 4rem; text-align: center;">
                    <div class="spinner-pro" style="margin: 0 auto 1rem;"></div>
                    <p style="color: var(--text-muted);">AI Ê≠£Âú®Á©øÈÄèÂÖ®Â∏ÇÂú∫Êï∞ÊçÆ...</p>
                </div>
            </div>
        </template>

        <!-- ========== ËµÑ‰∫ßÊåÅ‰ªì ========== -->
        <template v-if="mode === 'portfolio'">
            <div class="glass-card" id="portfolio-view">
                <div class="section-header">
                    <h2 class="section-title">üíº Ë¥¢ÂØåÈáëÂ∫ì</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="pro-btn"
                            style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #6366f1, #a855f7);"
                            @click="handlePortfolioDiagnose" :disabled="searchLoading || !portfolio.length">
                            <span v-if="searchLoading" class="spinner-pro" style="width: 14px; height: 14px;"></span>
                            <span v-else>ü©∫ ÂÅ•Â∫∑Ê£ÄÊü•</span>
                        </button>
                        <button class="pro-btn" style="padding: 0.5rem 1rem; background: rgba(255,255,255,0.05);"
                            @click="handleExportImage('portfolio-view')">
                            üì∏ ÂàÜ‰∫´
                        </button>
                        <button class="pro-btn" style="padding: 0.5rem 1rem;" @click="fetchPortfolio">
                            üîÑ Âà∑Êñ∞
                        </button>
                    </div>
                </div>

                <div v-if="portfolioSummary && portfolioSummary.total_positions > 0" class="glass-card"
                    style="background: linear-gradient(135deg, var(--primary), #8b5cf6); border: none; margin-bottom: 2rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">ËµÑ‰∫ßÊÄªËßÑÊ®°</div>
                            <div style="font-size: 2rem; font-weight: 800;">¬•{{
                                portfolioSummary.total_value?.toLocaleString() }}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.85rem; opacity: 0.8;">Á¥ØËÆ°Êî∂Áõä</div>
                            <div style="font-size: 2rem; font-weight: 800;"
                                :class="portfolioSummary.total_profit >= 0 ? 'font-up' : 'font-down'">
                                {{ portfolioSummary.total_profit >= 0 ? '+' : '' }}{{
                                portfolioSummary.total_profit?.toFixed(2) }}
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="portfolio.length" class="item-list">
                    <div v-for="pos in portfolio" :key="pos.id" class="fund-card">
                        <div class="fund-info-header">
                            <div style="flex: 1;" @click="analyzeFundByCode(pos.fund_code)">
                                <div class="fund-name">{{ pos.fund_name }}</div>
                                <div class="fund-code">{{ pos.fund_code }} ¬∑ {{ pos.shares }} ‰ªΩ</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="metric-value" style="font-size: 1.25rem;"
                                    :class="pos.profit >= 0 ? 'font-up' : 'font-down'">
                                    ¬•{{ pos.profit?.toFixed(2) }}
                                </div>
                                <div style="font-size: 0.8rem;" :class="pos.profit_rate >= 0 ? 'font-up' : 'font-down'">
                                    {{ pos.profit_rate >= 0 ? '+' : '' }}{{ pos.profit_rate?.toFixed(2) }}%
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                            <button class="pro-btn"
                                style="padding: 0.4rem 0.8rem; font-size: 0.75rem; background: rgba(244, 63, 94, 0.1); color: #f43f5e;"
                                @click="sellPosition(pos.id)">
                                ÂçñÂá∫
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Backtest Section -->
                <div v-if="portfolio.length > 0" class="glass-card"
                    style="margin-top: 2rem; border-top: 1px solid var(--glass-border); padding-top: 2rem;">
                    <div class="section-header">
                        <h3 class="section-title">üìä ÁªÑÂêàÂéÜÂè≤ÂõûÊµã (1Âπ¥Êúü)</h3>
                        <button class="pro-btn"
                            @click="runBacktest(portfolio.map(p=>({code:p.fund_code, weight: 100/portfolio.length})))"
                            :disabled="backtestLoading">
                            <span v-if="backtestLoading" class="spinner-pro"></span>
                            <span v-else>üöÄ ÂºÄÂßãÂõûÊµã</span>
                        </button>
                    </div>
                    <div v-if="backtestResult" style="margin-top: 1.5rem;">
                        <div class="stats-grid" style="margin-bottom: 1.5rem;">
                            <div class="data-card">
                                <div class="data-number"
                                    :class="backtestResult.metrics.total_return >= 0 ? 'font-up' : 'font-down'">
                                    {{ backtestResult.metrics.total_return }}%
                                </div>
                                <div class="data-label">Âπ¥ÂåñÊî∂Áõä</div>
                            </div>
                            <div class="data-card">
                                <div class="data-number text-down">{{ backtestResult.metrics.max_drawdown }}%</div>
                                <div class="data-label">ÊúÄÂ§ßÂõûÊí§</div>
                            </div>
                            <div class="data-card">
                                <div class="data-number">{{ backtestResult.metrics.sharpe }}</div>
                                <div class="data-label">Â§èÊôÆÊØîÁéá</div>
                            </div>
                        </div>
                        <!-- Backtest Chart Placeholder -->
                        <div
                            style="height: 200px; background: rgba(255,255,255,0.02); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); border: 1px dashed var(--glass-border);">
                            [ÁªÑÂêàÂáÄÂÄºËµ∞ÂäøÂõæÂ∑≤ÈõÜÊàê]
                        </div>
                    </div>
                </div>

            </div>

            <!-- Diagnosis Report Modal -->
            <div v-if="showDiagnosis" class="modal-overlay" @click.self="showDiagnosis = false">
                <div class="glass-card" id="diagnosis-report"
                    style="max-width: 800px; width: 95%; max-height: 85vh; padding: 0; display: flex; flex-direction: column;">
                    <div class="section-header" style="padding: 1.5rem; border-bottom: 1px solid var(--glass-border);">
                        <h2 class="section-title" style="margin-bottom: 0;">üß† Êô∫ËÉΩÁªÑÂêàËØäÊñ≠Êä•Âëä</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="pro-btn"
                                style="padding: 0.4rem 0.8rem; font-size: 0.8rem; background: rgba(255,255,255,0.1);"
                                @click="handleExportImage('diagnosis-report')">üì∏ ‰øùÂ≠òÂàÜ‰∫´</button>
                            <button class="pro-btn" style="padding: 0.5rem; background: transparent;"
                                @click="showDiagnosis = false">‚úï</button>
                        </div>
                    </div>
                    <div class="markdown-content" style="padding: 2rem; overflow-y: auto; flex: 1;">
                        <div v-if="diagnosisReport" v-html="renderMarkdown(diagnosisReport)"></div>

                        <!-- Diagnostics Pro Dashboard -->
                        <div v-if="diagnoseProData"
                            style="margin-top: 2rem; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 2rem;">
                            <h3 class="section-title" style="font-size: 1.1rem; margin-bottom: 1.5rem;">üìä Á©øÈÄèÂºèËµÑ‰∫ßÈÖçÁΩÆ (Pro)
                            </h3>

                            <div class="allocation-bar">
                                <div class="alloc-equity" :style="{width: diagnoseProData.allocation.equity + '%'}">
                                </div>
                                <div class="alloc-bond" :style="{width: diagnoseProData.allocation.bond + '%'}"></div>
                                <div class="alloc-cash" :style="{width: diagnoseProData.allocation.cash + '%'}"></div>
                            </div>

                            <div style="display: flex; gap: 1.5rem; margin-bottom: 2.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                    <div
                                        style="width: 10px; height: 10px; border-radius: 2px; background: var(--primary);">
                                    </div>
                                    <span>ÊùÉÁõä: {{ diagnoseProData.allocation.equity.toFixed(1) }}%</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                    <div style="width: 10px; height: 10px; border-radius: 2px; background: #6366f1;">
                                    </div>
                                    <span>Âõ∫Êî∂: {{ diagnoseProData.allocation.bond.toFixed(1) }}%</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                    <div style="width: 10px; height: 10px; border-radius: 2px; background: #94a3b8;">
                                    </div>
                                    <span>Áé∞Èáë: {{ diagnoseProData.allocation.cash.toFixed(1) }}%</span>
                                </div>
                            </div>

                            <h3 class="section-title" style="font-size: 1.1rem; margin-bottom: 1.5rem;">üå™Ô∏è ÊûÅÁ´ØÂú∫ÊôØÂéãÂäõÊµãËØï
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                <div v-for="s in diagnoseProData.scenarios" :key="s.name" class="stress-test-card">
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">{{
                                        s.name }}</div>
                                    <div :class="s.impact >= 0 ? 'font-up' : 'font-down'"
                                        style="font-size: 1.25rem; font-weight: 800;">
                                        {{ s.impact >= 0 ? '+' : '' }}{{ s.impact.toFixed(2) }}%
                                    </div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem;">‰º∞ÁÆóÊçüÁõäÈ¢ù:
                                        ¬•{{ (portfolio.reduce((s, p) => s + p.cost_price * p.shares, 0) * s.impact /
                                        100).toFixed(0) }}</div>
                                </div>
                            </div>
                        </div>

                        <div v-else-if="loadingDiagnosePro" style="text-align: center; padding: 2rem;">
                            <div class="spinner-pro" style="margin: 0 auto 1rem;"></div>
                            <p style="font-size: 0.85rem; color: var(--text-muted);">Ê≠£Âú®ËøõË°åÁ©øÈÄèÂºèÂ∫ïÂ±ÇËµÑ‰∫ßÁ©øÈÄè‰∏éËµÑ‰∫ßÈÖçÁΩÆËÆ°ÁÆó...</p>
                        </div>

                        <div v-if="!diagnosisReport && !loadingDiagnosePro" style="text-align: center; padding: 3rem;">
                            <div class="spinner-pro" style="margin: 0 auto 1rem;"></div>
                            <p style="color: var(--text-muted);">AI Ê≠£Âú®Êâ´ÊèèÂÖ®Â∏ÇÂú∫È£éÈô©Âõ†Â≠êÔºåÂàÜÊûêËµÑ‰∫ßÁõ∏ÂÖ≥ÊÄß...</p>
                        </div>
                    </div>
                    <div style="padding: 1.5rem; border-top: 1px solid var(--glass-border); text-align: right;">
                        <button class="pro-btn" @click="showDiagnosis = false">Á°ÆÂÆö</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- ========== ÊàëÁöÑËá™ÈÄâ ========== -->
        <template v-if="mode === 'watchlist'">
            <div class="glass-card">
                <div class="section-header">
                    <h2 class="section-title">‚≠ê ÊàëÁöÑËá™ÈÄâ</h2>
                    <button class="pro-btn" style="padding: 0.5rem 1rem;" @click="fetchWatchlist">
                        üîÑ Âà∑Êñ∞
                    </button>
                </div>

                <div v-if="watchlistLoading" style="padding: 4rem; text-align: center;">
                    <div class="spinner-pro" style="margin: 0 auto;"></div>
                </div>

                <div v-else-if="watchlist.length" class="item-list">
                    <div v-for="fund in watchlist" :key="fund.code" class="fund-card"
                        @click="analyzeFundByCode(fund.code)">
                        <div class="fund-info-header">
                            <div style="flex: 1;">
                                <div class="fund-name">{{ fund.name }}</div>
                                <div class="fund-code">{{ fund.code }}</div>
                            </div>
                            <div style="text-align: right; margin-right: 1rem;">
                                <div class="metric-value" style="font-size: 1.1rem;"
                                    :class="fund.estimation_growth >= 0 ? 'font-up' : 'font-down'">
                                    {{ fund.estimation_nav?.toFixed(4) || '--' }}
                                </div>
                                <div style="font-size: 0.8rem;"
                                    :class="fund.estimation_growth >= 0 ? 'font-up' : 'font-down'">
                                    {{ fund.estimation_growth >= 0 ? '+' : '' }}{{ fund.estimation_growth?.toFixed(2)
                                    }}% (‰º∞)
                                </div>
                            </div>
                            <button class="pro-btn" style="padding: 0.4rem; background: transparent; color: #f43f5e;"
                                @click.stop="removeFromWatchlist(fund.code)">
                                üóëÔ∏è
                            </button>
                        </div>
                        <!-- Sparkline Chart -->
                        <div v-if="fund.chart_data && fund.chart_data.length"
                            style="margin-top: 0.8rem; height: 30px; opacity: 0.6;">
                            <svg width="100%" height="30" preserveAspectRatio="none">
                                <path :d="generateSparkline(fund.chart_data)" fill="none"
                                    :stroke="fund.estimation_growth >= 0 ? 'var(--success)' : 'var(--accent)'"
                                    stroke-width="1.5" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div v-else style="padding: 5rem; text-align: center;">
                    <p style="color: var(--text-muted); margin-bottom: 2rem;">ÊöÇÊó†Ëá™ÈÄâ</p>
                    <button class="pro-btn" @click="mode = 'search'">ÂéªÊêúÁ¥¢Âü∫Èáë</button>
                </div>
            </div>
        </template>

        <!-- ========== ÂÆèËßÇËßÜÈáé ========== -->
        <template v-if="mode === 'macro'">
            <div class="glass-card">
                <div class="section-header">
                    <h2 class="section-title">üåê ÂÆèËßÇËßÜÈáé</h2>
                    <button class="pro-btn" @click="fetchMacroData">üîÑ Âà∑Êñ∞</button>
                </div>

                <div v-if="!macroData" style="padding: 5rem; text-align: center;">
                    <div class="spinner-pro" style="margin: 0 auto 1rem;"></div>
                    <p style="color: var(--text-muted);">Ê≠£Âú®ËøûÊé•ÂÖ®ÁêÉÈáëËûçÊï∞ÊçÆÂ∫ì...</p>
                </div>

                <div v-else class="strategy-container">
                    <div class="stats-grid">
                        <div class="data-card">
                            <div class="data-label">10Y ÂõΩÂÄ∫Êî∂ÁõäÁéá (‰∏≠)</div>
                            <div class="data-number" style="color: #6366f1;">{{ macroData.yield_curve.cn_10y }}%</div>
                        </div>
                        <div class="data-card">
                            <div class="data-label">10Y ÂõΩÂÄ∫Êî∂ÁõäÁéá (Áæé)</div>
                            <div class="data-number" style="color: #f43f5e;">{{ macroData.yield_curve.us_10y }}%</div>
                        </div>
                        <div class="data-card">
                            <div class="data-label">‰∏≠ÁæéÂà©Â∑Æ</div>
                            <div class="data-number"
                                :style="{color: macroData.yield_curve.spread < 0 ? '#f43f5e' : '#10b981'}">
                                {{ macroData.yield_curve.spread }}%
                            </div>
                        </div>
                    </div>

                    <div class="glass-card"
                        style="background: rgba(99,102,241,0.05); border: 1px solid rgba(99,102,241,0.2);">
                        <h3 class="section-title" style="font-size: 1rem;">üíµ Ê±áÁéáÂä®Âêë</h3>
                        <div style="display: flex; align-items: baseline; gap: 1rem; margin-top: 1rem;">
                            <div style="font-size: 2rem; font-weight: 800;">USD/CNY: {{ macroData.currency.usd_cny }}
                            </div>
                            <div style="color: var(--text-muted); font-size: 0.9rem;">ÂÆûÊó∂‰∏≠Èó¥‰ª∑ÂèÇËÄÉ</div>
                        </div>
                    </div>

                    <div class="glass-card">
                        <h3 class="section-title" style="font-size: 1rem;">üß† AI ÂÆèËßÇÂ±ïÊúõ</h3>
                        <p style="font-size: 0.95rem; line-height: 1.8; color: var(--text-muted); margin-top: 1rem;">
                            ÂΩìÂâç‰∏≠ÁæéÂà©Â∑ÆÁª¥ÊåÅÂú® <b>{{ macroData.yield_curve.spread }}%</b>ÔºåÂØπÊùÉÁõäÁ±ªËµÑ‰∫ßÁâπÂà´ÊòØÈ´òÊàêÈïøÊùøÂùóÔºàÁßëÂàõÊùø„ÄÅÊ∏ØËÇ°Ôºâ‰ªçÊúâ‰∏ÄÂÆö‰º∞ÂÄºÂéãÂäõ„ÄÇ
                            USD/CNY Êä• <b>{{ macroData.currency.usd_cny }}</b>ÔºåÂá∫Âè£Âûã‰ºÅ‰∏öÊ±áÂÖëÊçüÁõäÂèØËÉΩÂ¢ûÂéö„ÄÇÂª∫ËÆÆÂÖ≥Ê≥®ÂÖ∑Â§áÂØπÂÜ≤ËÉΩÂäõÁöÑÁ∫¢Âà©ËµÑ‰∫ß„ÄÇ
                        </p>
                    </div>
                </div>
            </div>
        </template>

        <!-- ========== ‰∏ì‰∏öÂ∑•ÂÖ∑ ========== -->
        <template v-if="mode === 'tools'">
            <div class="glass-card">
                <h2 class="section-title">üõ†Ô∏è ‰∏ì‰∏öÈáèÂåñÂ∑•ÂÖ∑</h2>

                <!-- Fee Ninja -->
                <div class="glass-card" style="margin-top: 1.5rem;">
                    <h3 class="section-title" style="font-size: 1.1rem;">ü•∑ Ë¥πÁéáÁ≤æÁÆóÂ∏à (Fee Ninja)</h3>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 2rem;">
                        ËÆ°ÁÆó‰∏çÂêåÊåÅ‰ªìÂë®Êúü‰∏ãÔºåÁÆ°ÁêÜË¥π‰∏éÁî≥Ë¥≠ÂØπËµÑ‰∫ßÁöÑÈöêÂΩ¢‰æµËöÄ</p>

                    <div
                        style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                        <div>
                            <label style="display: block; font-size: 0.8rem; margin-bottom: 0.5rem;">Ê®°ÊãüÊú¨Èáë (¬•)</label>
                            <input type="number" v-model="feeCalculator.amount" class="pro-input">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.8rem; margin-bottom: 0.5rem;">ÊåÅ‰ªìÂπ¥Èôê</label>
                            <input type="number" v-model="feeCalculator.years" class="pro-input">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.8rem; margin-bottom: 0.5rem;">Âπ¥ÁªºË¥πÁéá (%)</label>
                            <input type="number" v-model="feeCalculator.rate" step="0.1" class="pro-input">
                        </div>
                    </div>

                    <button class="pro-btn" style="width: 100%; padding: 1rem;" @click="calculateFee"
                        :disabled="feeCalculator.loading">
                        <span v-if="feeCalculator.loading" class="spinner-pro"></span>
                        <span v-else>Á´ãÂç≥ËØïÁÆó</span>
                    </button>

                    <div v-if="feeCalculator.result"
                        style="margin-top: 2rem; padding: 1.5rem; background: rgba(244, 63, 94, 0.05); border-radius: 12px; border: 1px dashed rgba(244, 63, 94, 0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-muted);">ÊÄªËÆ°Ë¥πÁî®ÊçüÂ§±</span>
                            <span class="text-down" style="font-size: 1.5rem; font-weight: 800;">-¬•{{
                                feeCalculator.result.fee_loss }}</span>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; text-align: right;">
                            Áõ∏ÂΩì‰∫éÊçüÂ§±‰∫ÜÂàùÂßãÊú¨ÈáëÁöÑ <b>{{ (feeCalculator.result.fee_loss / feeCalculator.result.original_amount *
                                100).toFixed(2) }}%</b>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Optimizer (Coming Soon) -->
                <div class="glass-card" style="margin-top: 1.5rem; opacity: 0.6; pointer-events: none;">
                    <h3 class="section-title" style="font-size: 1.1rem;">üß™ Êô∫ËÉΩË∞É‰ªì‰∏ìÂÆ∂ (Coming Soon)</h3>
                    <p style="font-size: 0.85rem;">Âü∫‰∫éÈ©¨ÁßëÁª¥Ëå®ÊúâÊïàÂâçÊ≤ø (Markowitz Model) ÁöÑËá™Âä®ÊùÉÈáçÂàÜÈÖç</p>
                </div>
            </div>
        </template>

        <!-- ========== ÂêåÊ≠•ÂºπÁ™ó ========== -->
        <div v-if="showUpdateDialog" class="modal-overlay" @click.self="showUpdateDialog = false">
            <div class="glass-card" style="max-width: 400px; width: 90%; padding: 2rem; text-align: center;">
                <h2 class="section-title" style="justify-content: center; margin-bottom: 1rem;">üîÑ ÂêåÊ≠•Êï∞ÊçÆ</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">ËæìÂÖ•ÁÆ°ÁêÜÂëò Token ‰ª•ÂêåÊ≠•ÊúÄÊñ∞Êï∞ÊçÆ</p>

                <div v-if="updateMessage"
                    :style="{padding: '1rem', borderRadius: '8px', marginBottom: '1rem', background: updateSuccess ? 'rgba(16, 185, 129, 0.1)' : 'rgba(244, 63, 94, 0.1)', color: updateSuccess ? 'var(--success)' : 'var(--accent)'}">
                    {{ updateMessage }}
                </div>

                <input type="password" v-model="adminToken" placeholder="ÁÆ°ÁêÜÂëò Token" class="pro-input"
                    style="margin-bottom: 1rem;">

                <div style="display: flex; gap: 1rem;">
                    <button class="pro-btn" style="flex: 1;" @click="triggerUpdate" :disabled="updating">
                        {{ updating ? 'ÂêåÊ≠•‰∏≠...' : 'ÂºÄÂßãÂêåÊ≠•' }}
                    </button>
                    <button class="pro-btn" style="flex: 1; background: rgba(255,255,255,0.05);"
                        @click="showUpdateDialog = false">
                        ÂèñÊ∂à
                    </button>
                </div>
            </div>
        </div>

        <!-- PK Compare Floating Bar -->
        <div v-if="compareList.length > 0" class="compare-bar">
            <div style="font-weight: 700; color: var(--primary);">PK ÁØÆÂ≠ê ({{ compareList.length }}/3)</div>
            <div class="compare-item" v-for="f in compareList" :key="f.code">
                <span>{{ f.name }}</span>
                <span style="cursor: pointer; opacity: 0.6;" @click="toggleCompare(f)">‚úï</span>
            </div>
            <button class="pro-btn" style="padding: 0.4rem 1.2rem; border-radius: 20px;"
                :disabled="compareList.length < 2" @click="fetchComparisonMatrix">ü•á ÂºÄÂßãÂØπÊØî</button>
        </div>

        <!-- PK Modal -->
        <div class="deep-dive-overlay"
            style="z-index: 1500; display: flex; align-items: center; justify-content: center;" v-if="showPk"
            @click="showPk = false">
            <div class="pk-modal" style="width: 900px; max-width: 95vw;" @click.stop>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="margin: 0;">üìä Âü∫ÈáëÂº∫Âº∫ÂØπÂÜ≥ (Pro)</h2>
                    <button class="close-btn" @click="showPk = false"
                        style="position: static; padding: 0.5rem;">‚úï</button>
                </div>

                <div v-if="loadingCompare" style="padding: 4rem; text-align: center;">
                    <div class="spinner-pro" style="margin: 0 auto;"></div>
                    <p style="margin-top: 1rem; color: var(--text-muted);">Ê≠£Âú®ËÆ°ÁÆóÊåÅ‰ªìÈáçÂêàÂ∫¶‰∏éÊ†∏ÂøÉÊåáÊ†á...</p>
                </div>

                <div v-else-if="compareData" style="overflow-y: auto; max-height: 70vh;">
                    <!-- Similarity Alert -->
                    <div v-if="compareData.similarity && compareData.similarity.overlap_ratio > 30"
                        class="similarity-alert">
                        <span>‚ö†Ô∏è</span>
                        <div>
                            <strong>È´òÂ∫¶ÊåÅ‰ªìÈáçÂêà ({{ compareData.similarity.overlap_ratio }}%)</strong>
                            <p style="font-size: 0.8rem; opacity: 0.8;">ÈÄâÂÆöÂü∫ÈáëÂ∫ïÂ±ÇËµÑ‰∫ßÈùûÂ∏∏Êé•ËøëÔºåÂàÜÊï£ÊäïËµÑÊïàÊûúÊúâÈôê„ÄÇ</p>
                        </div>
                    </div>

                    <div class="pk-matrix-3">
                        <div class="pk-cell pk-header-cell">Âü∫Êú¨‰ø°ÊÅØ</div>
                        <div v-for="f in compareData.data" :key="f.code" class="pk-cell"
                            style="flex-direction: column;">
                            <div style="font-weight: 700;">{{ f.name }}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">{{ f.code }}</div>
                        </div>

                        <div class="pk-cell pk-header-cell">AI ËØÑÂàÜ</div>
                        <div v-for="f in compareData.data" :key="f.code" class="pk-cell">
                            <div class="score-pill" :class="getScoreClass(f.grade)">{{ f.score || '-' }}</div>
                        </div>

                        <div class="pk-cell pk-header-cell">Ëøë1Âπ¥Êî∂Áõä</div>
                        <div v-for="f in compareData.data" :key="f.code" class="pk-cell"
                            :class="f.return_1y >= 0 ? 'font-up' : 'font-down'">
                            {{ f.return_1y ? f.return_1y.toFixed(2) + '%' : '-' }}
                        </div>

                        <div class="pk-cell pk-header-cell">Â§èÊôÆÊØîÁéá</div>
                        <div v-for="f in compareData.data" :key="f.code" class="pk-cell">
                            {{ f.sharpe || '-' }}
                        </div>

                        <div class="pk-cell pk-header-cell">ÊúÄÂ§ßÂõûÊí§</div>
                        <div v-for="f in compareData.data" :key="f.code" class="pk-cell font-down">
                            {{ f.max_drawdown ? f.max_drawdown.toFixed(2) + '%' : '-' }}
                        </div>

                        <div class="pk-cell pk-header-cell">Âü∫ÈáëÁªèÁêÜ</div>
                        <div v-for="f in compareData.data" :key="f.code" class="pk-cell" style="font-size: 0.9rem;">
                            {{ f.manager_info?.name || 'Êú™Áü•' }}
                        </div>
                    </div>

                    <div
                        style="margin-top: 2rem; padding: 1.5rem; background: rgba(99, 102, 241, 0.1); border-radius: 16px;">
                        <div style="font-weight: 700; margin-bottom: 0.5rem;">ü§ñ AI Ê∑±Â∫¶ÂØπÊØîÂª∫ËÆÆ</div>
                        <div style="font-size: 0.9rem; line-height: 1.6; color: var(--text-main);">
                            Âü∫‰∫éÂ§öÁª¥Êï∞ÊçÆÂàÜÊûêÔºåÂü∫Èáë <strong>{{ compareData.data[0].name }}</strong> Ë°®Áé∞Âá∫Êõ¥Âº∫ÁöÑÈò≤Âæ°Â±ûÊÄßÔºåÈÄÇÂêàÂΩìÂâçÈúáËç°Ë°åÊÉÖ„ÄÇ
                            <strong>{{ compareData.data[1].name }}</strong> Âú®ÂèçÂºπË°åÊÉÖ‰∏≠ÂºπÊÄßÊõ¥Â§ß„ÄÇÂª∫ËÆÆÊ†πÊçÆ‰∏™‰∫∫È£éÈô©ÊâøÂèóËÉΩÂäõËøõË°åÂàÜÈÖç„ÄÇ
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÂÖçË¥£Â£∞Êòé -->
        <div class="disclaimer">
            ‚ö†Ô∏è ‰ª•‰∏äÂàÜÊûê‰ªÖ‰æõÂèÇËÄÉÔºå‰∏çÊûÑÊàêÊäïËµÑÂª∫ËÆÆ„ÄÇÊäïËµÑÊúâÈ£éÈô©ÔºåÂÖ•Â∏ÇÈúÄË∞®ÊÖé„ÄÇ
        </div>

        <!-- Filter Drawer -->
        <div class="filter-drawer" :class="{active: showFilterDrawer}">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem;">
                <h3 style="margin: 0; font-size: 1.25rem;">üîç È´òÁ∫ßÁ≠õÈÄâ</h3>
                <button @click="showFilterDrawer = false"
                    style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>

            <div class="filter-group">
                <label class="filter-label">ËµÑ‰∫ßËßÑÊ®°</label>
                <div class="filter-options">
                    <div class="filter-chip" :class="{active: activeFilters.scale === 'all'}"
                        @click="activeFilters.scale = 'all'">ÂÖ®ÈÉ®</div>
                    <div class="filter-chip" :class="{active: activeFilters.scale === '50'}"
                        @click="activeFilters.scale = '50'">50‰∫ø+</div>
                    <div class="filter-chip" :class="{active: activeFilters.scale === '100'}"
                        @click="activeFilters.scale = '100'">100‰∫ø+</div>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Âü∫ÈáëÁªèÁêÜÂπ¥ËµÑ</label>
                <div class="filter-options">
                    <div class="filter-chip" :class="{active: activeFilters.tenure === 'all'}"
                        @click="activeFilters.tenure = 'all'">ÂÖ®ÈÉ®</div>
                    <div class="filter-chip" :class="{active: activeFilters.tenure === '3'}"
                        @click="activeFilters.tenure = '3'">3Âπ¥‰ª•‰∏ä</div>
                    <div class="filter-chip" :class="{active: activeFilters.tenure === '5'}"
                        @click="activeFilters.tenure = '5'">5Âπ¥‰ª•‰∏ä</div>
                </div>
            </div>

            <div style="position: absolute; bottom: 2rem; left: 2rem; right: 2rem; display: flex; gap: 1rem;">
                <button class="pro-btn" style="flex: 1; padding: 1rem;" @click="applyFilters">Â∫îÁî®Á≠õÈÄâ</button>
                <button class="pro-btn" style="background: rgba(255,255,255,0.05); padding: 1rem;"
                    @click="activeFilters = {scale:'all', tenure:'all', type:'all'}">ÈáçÁΩÆ</button>
            </div>
        </div>

        <!-- Floating AI Toggle -->
        <div class="floating-ai-btn" @click="showChat = !showChat">
            <div class="ai-icon-inner">ü§ñ</div>
            <div class="ai-dot"></div>
        </div>

        <!-- AI Chat Assistant (Phase 4) -->
        <div class="chat-panel" :class="{active: showChat}">
            <div class="chat-header">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div
                        style="background: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                        ü§ñ</div>
                    <div style="font-weight: 700;">AI ÁßÅ‰∫∫ÁÆ°ÂÆ∂</div>
                </div>
                <button @click="showChat = false"
                    style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem;">‚úï</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div v-for="(msg, idx) in chatMessages" :key="idx" class="message" :class="'message-' + msg.role">
                    <div v-html="renderMarkdown(msg.content)"></div>

                    <div v-if="msg.funds && msg.funds.length"
                        style="margin-top: 1rem; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 1rem;">
                        <div v-for="f in msg.funds" :key="f.code" class="fund-mini-card"
                            @click="analyzeFundByCode(f.code); showChat = false">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-weight: 700;">{{ f.name }}</div>
                                <div class="score-pill" :class="getScoreClass(f.grade)" style="font-size: 0.7rem;">{{
                                    f.grade }}</div>
                            </div>
                            <div
                                style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                                <span>Êî∂Áõä: <b :class="f.return_1y >= 0 ? 'font-up' : 'font-down'">{{
                                        f.return_1y?.toFixed(2) }}%</b></span>
                                <span>ÂõûÊí§: <b class="font-down">{{ f.max_drawdown?.toFixed(2) }}%</b></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="chatLoading" class="message message-ai">
                    <div class="spinner-pro" style="margin-left: 0;"></div>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="chat-input-container">
                    <input type="text" v-model="chatInput" @keyup.enter="sendChatMessage"
                        placeholder="ËØïËØïËØ¥ÔºöÊâæ‰∏ÄÂè™ÂõûÊí§‰Ωé„ÄÅÊî∂ÁõäÈ´òÁöÑÁßëÊäÄÂü∫Èáë..." class="chat-input">
                    <button @click="sendChatMessage" :disabled="!chatInput || chatLoading"
                        style="background: none; border: none; color: var(--primary); cursor: pointer; padding: 0.5rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        </main>
    </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8000'
            : window.location.origin;

        const STORAGE_BASE = `${API_BASE}/static/storage`;

        // IndexedDB Wrapper
        const LocalDB = {
            dbName: 'FundAdvisorLocal',
            version: 1,
            init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('watchlist')) {
                            db.createObjectStore('watchlist', { keyPath: 'code' });
                        }
                        if (!db.objectStoreNames.contains('portfolio')) {
                            db.createObjectStore('portfolio', { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            },
            async getAll(storeName) {
                const db = await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            async put(storeName, data) {
                const db = await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            async delete(storeName, key) {
                const db = await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
        };

        createApp({
            setup() {
                // Áä∂ÊÄÅ
                const mode = ref('recommend');
                const loading = ref(false);
                const errorMsg = ref('');

                // Êé®ËçêÈ°µ
                const recommendations = ref(null);
                const recommendAiSummary = ref('');
                const predictions = ref([]); // New for V4
                const recTab = ref('top10');
                const recTabs = [
                    { key: 'top10', label: 'üèÜ TOP10' },
                    { key: 'high_alpha', label: 'üìà È´òAlpha' },
                    { key: 'long_term', label: 'üíé ÈïøÁ∫ø' },
                    { key: 'short_term', label: '‚ö° Áü≠Á∫ø' },
                    { key: 'low_beta', label: 'üõ°Ô∏è Èò≤ÂÆà' }
                ];

                // ÊêúÁ¥¢È°µ
                const searchQuery = ref('');
                const searchResults = ref([]);
                const searchInterpretation = ref('');
                const searchLoading = ref(false);
                const fundDetail = ref(null);
                const fullFundList = ref([]); // Store static list for local filter
                const scannerTags = [
                    { icon: 'ü¶∏', label: 'ÊäóË∑åËã±ÈõÑ', query: 'Ëøë1Âπ¥ÂõûÊí§Â∞è‰∫é5%‰∏îÊî∂Áõä‰∏∫Ê≠£' },
                    { icon: 'üèÜ', label: 'È´òÊÄß‰ª∑ÊØî', query: 'Â§èÊôÆÊØîÁéáÂ§ß‰∫é1.5' },
                    { icon: 'üöÄ', label: 'ËøõÊîªÂ∞ñÂÖµ', query: 'Ëøë1Âπ¥Êî∂ÁõäÂ§ß‰∫é20%ÁöÑÁßëÊäÄÊàñÊñ∞ËÉΩÊ∫ê' },
                    { icon: 'üõ°Ô∏è', label: 'Á®≥ÂÅ•Á∫¢Âà©', query: '‰ΩéÈ£éÈô©‰∏îÂàÜÁ∫¢È´òÁöÑ‰ª∑ÂÄºÂü∫Èáë' }
                ];
                let searchTimer = null;

                // Ê∂®ÂπÖÊ¶ú
                const topGainers = ref([]);
                const gainerPeriod = ref('1w');
                const gainerLoading = ref(false);
                const gainerPeriods = [
                    { value: 'yesterday', label: 'Êò®Êó•' },
                    { value: 'today_estimate', label: '‰ªäÊó•‰º∞ÁÆó' },
                    { value: '1w', label: '1Âë®' },
                    { value: '1m', label: '1Êúà' },
                    { value: '3m', label: '3Êúà' },
                    { value: '6m', label: '6Êúà' }, // Added
                    { value: '1y', label: '1Âπ¥' }, // Added
                    { value: '2y', label: '2Âπ¥' }, // Added
                    { value: '3y', label: '3Âπ¥' }, // Added
                    { value: '5y', label: '5Âπ¥' }  // Added
                ];

                // ÊåÅ‰ªì
                const portfolio = ref([]);
                const portfolioSummary = ref(null);

                // Ëá™ÈÄâ
                const watchlist = ref([]);
                const watchlistLoading = ref(false);

                // ËØäÊñ≠
                const showDiagnosis = ref(false);
                const diagnosisReport = ref('');

                // V4 Edge States
                const showRadar = ref(false);
                const defaultRadar = { 'Êî∂ÁõäÂäõ': 75, 'ÊäóË∑åÂäõ': 82, 'ÊÄß‰ª∑ÊØî': 68, 'ÁªèÁêÜËÉΩÂäõ': 85, 'ÂÖ¨Âè∏ÂÆûÂäõ': 90 };
                const showDca = ref(false);
                const dcaResults = ref(null);

                // PK Comparison
                const compareList = ref([]);
                const showPk = ref(false);
                const compareData = ref(null);
                const loadingCompare = ref(false);

                // Professional Features State
                const macroData = ref(null);
                const backtestResult = ref(null);
                const backtestLoading = ref(false);
                const diagnoseProData = ref(null);
                const loadingDiagnosePro = ref(false);

                // Phase 4: AI Chat
                const showChat = ref(false);
                const chatInput = ref('');
                const chatMessages = ref([
                    { role: 'ai', content: 'ÊÇ®Â•ΩÔºÅÊàëÊòØÊÇ®ÁöÑ AI ÁßÅ‰∫∫ÁÆ°ÂÆ∂„ÄÇÊÇ®ÂèØ‰ª•Áõ¥Êé•ÂëäËØâÊàëÊÇ®ÁöÑÊäïËµÑÂÅèÂ•ΩÔºåÊàë‰ºö‰∏∫ÊÇ®Âú®ÂÖ®ÁêÉËåÉÂõ¥Á≠õÈÄâÊúÄÂêàÈÄÇÁöÑÂü∫Èáë„ÄÇ' }
                ]);
                const chatLoading = ref(false);

                const feeCalculator = ref({
                    amount: 100000,
                    years: 1,
                    rate: 1.5,
                    result: null,
                    loading: false
                });

                const showFilterDrawer = ref(false);
                const activeFilters = ref({
                    scale: 'all',
                    tenure: 'all',
                    type: 'all'
                });

                const wikiTerms = {
                    'Alpha': 'Alpha ÊòØË∂ÖÈ¢ùÊî∂ÁõäÔºåÂç≥Âü∫ÈáëÊî∂ÁõäÁéá‰∏éÂü∫ÂáÜÊî∂ÁõäÁéá‰πãÂ∑Æ„ÄÇÊ≠£ Alpha Ë°®Á§∫Âü∫ÈáëË∂ÖË∂ä‰∫ÜÂ∏ÇÂú∫„ÄÇ',
                    'Sharpe': 'Â§èÊôÆÊØîÁéáË°°ÈáèÊØèÂçï‰ΩçÈ£éÈô©Â∏¶Êù•ÁöÑË∂ÖÈ¢ùÊî∂Áõä„ÄÇÈÄöÂ∏∏Â§ß‰∫é 1 Ë¢´ËÆ§‰∏∫ÊòØ‰ºòÁßÄÁöÑÊî∂ÁõäÈ£éÈô©ÊØî„ÄÇ',
                    'Sortino': 'Á¥¢ÊèêËØ∫ÊØîÁéá‰∏éÂ§èÊôÆÊØîÁéáÁ±ª‰ººÔºå‰ΩÜÂÆÉÂè™ËÄÉËôë‰∏ãË°åÈ£éÈô©Ôºà‰∏ãË∑åÊ≥¢ÂπÖÔºâÔºåÂØπÁ®≥ÂÅ•ÂûãÊäïËµÑËÄÖÊõ¥ÊúâÂèÇËÄÉ‰ª∑ÂÄº„ÄÇ',
                    'MaxDrawdown': 'ÊúÄÂ§ßÂõûÊí§ÊåáÂú®ÈÄâÂÆöÂë®ÊúüÂÜÖÊî∂ÁõäÁéá‰ªéÊúÄÈ´òÁÇπÂà∞ÊúÄ‰ΩéÁÇπÁöÑÊúÄÂ§ßË∑åÂπÖÔºåÊòØË°°ÈáèÊäóË∑åËÉΩÂäõÁöÑÊ†∏ÂøÉÊåáÊ†á„ÄÇ',
                    'Beta': 'Beta Ë°°ÈáèÂü∫ÈáëÂØπÂ∏ÇÂú∫Ê≥¢Âä®ÁöÑÊïèÊÑüÂ∫¶„ÄÇBeta = 1 Ë°®Á§∫‰∏éÂ∏ÇÂú∫ÂêåÊ≠•ÔºõBeta > 1 Ë°®Á§∫Ê≥¢Âä®Â§ß‰∫éÂ∏ÇÂú∫„ÄÇ'
                };

                function toggleCompare(fund) {
                    const idx = compareList.value.findIndex(f => f.code === fund.code);
                    if (idx > -1) {
                        compareList.value.splice(idx, 1);
                    } else {
                        if (compareList.value.length < 3) {
                            compareList.value.push(fund);
                        } else {
                            showError('ÊúÄÂ§öÊîØÊåÅ3Âè™Âü∫ÈáëËøõË°åPK');
                        }
                    }
                }

                async function fetchComparisonMatrix() {
                    if (compareList.value.length < 2) return;
                    loadingCompare.value = true;
                    showPk.value = true;
                    compareData.value = null;
                    try {
                        const res = await fetch(`${API_BASE}/v1/compare`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ codes: compareList.value.map(f => f.code) })
                        });
                        const data = await res.json();
                        if (data.status === 'success') {
                            compareData.value = data;
                        }
                    } catch (e) {
                        showError('ÂØπÊØîÂä†ËΩΩÂ§±Ë¥•');
                    } finally {
                        loadingCompare.value = false;
                    }
                }

                const crashLibrary = [
                    { date: '2015-06-12', label: '5178 È°∂ÈÉ®', color: '#ef4444' },
                    { date: '2015-08-24', label: 'ËÇ°ÁÅæ2.0', color: '#ef4444' },
                    { date: '2018-01-29', label: 'Ë¥∏ÊòìÊàòÂõûË∞É', color: '#ef4444' },
                    { date: '2020-02-03', label: 'Áñ´ÊÉÖÂ∫ï', color: '#10b981' },
                    { date: '2022-04-26', label: '‰º∞ÂÄºÂ∫ï', color: '#10b981' },
                    { date: '2024-02-05', label: 'Èõ™ÁêÉÈáçÈî§', color: '#ef4444' }
                ];

                const chartPath = computed(() => {
                    if (!fundDetail.value?.history_nav?.length) return '';
                    const data = fundDetail.value.history_nav;
                    const width = 800;
                    const height = 200;
                    const padding = 20;

                    const navs = data.map(d => parseFloat(d.nav)).filter(v => !isNaN(v));
                    const max = Math.max(...navs);
                    const min = Math.min(...navs);
                    const range = max - min || 1;

                    return data.map((d, i) => {
                        const x = (i / (data.length - 1)) * (width - 2 * padding) + padding;
                        const y = height - ((parseFloat(d.nav) - min) / range * (height - 2 * padding) + padding);
                        return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                    }).join(' ');
                });

                const crashMarkers = computed(() => {
                    if (!fundDetail.value?.history_nav?.length) return [];
                    const data = fundDetail.value.history_nav;
                    const width = 800;
                    const height = 200;
                    const padding = 20;

                    const navs = data.map(d => parseFloat(d.nav)).filter(v => !isNaN(v));
                    const max = Math.max(...navs);
                    const min = Math.min(...navs);
                    const range = max - min || 1;

                    return crashLibrary.filter(c => {
                        const dateStr = c.date;
                        return data.some(d => d.date && d.date.startsWith(dateStr.substring(0, 7)));
                    }).map(c => {
                        const idx = data.findIndex(d => d.date && d.date.startsWith(c.date.substring(0, 7)));
                        const x = (idx / (data.length - 1)) * (width - 2 * padding) + padding;
                        const y = height - ((parseFloat(data[idx].nav) - min) / range * (height - 2 * padding) + padding);
                        return { ...c, x, y };
                    });
                });

                // ÂêåÊ≠•ÂºπÁ™ó
                const showUpdateDialog = ref(false);
                const adminToken = ref('');
                const updating = ref(false);
                const updateMessage = ref('');
                const updateSuccess = ref(false);

                // Fund Channel Data
                const marketHotspots = ref({ hotspots: [], news_count: 0 });
                const hotSectors = ref([]);
                const rankingListData = ref([]);
                const rankTab = ref('score');
                const loadingRankings = ref(false);
                const loadingHotspots = ref(false);
                const loadingSectors = ref(false);

                // Phase 2: Sector Deep Dive
                const showSectorModal = ref(false);
                const selectedSector = ref('');
                const sectorDetail = ref(null);
                const loadingSectorDetail = ref(false);

                // ËÆ°ÁÆóÂ±ûÊÄß
                const currentList = computed(() => {
                    if (!recommendations.value?.recommendations) return [];
                    return recommendations.value.recommendations[recTab.value] || [];
                });

                // ÊñπÊ≥ï
                function showError(msg) {
                    errorMsg.value = msg;
                    setTimeout(() => { errorMsg.value = ''; }, 3000);
                }

                function getScoreClass(grade) {
                    if (!grade) return 'score-C';
                    const f = grade.charAt(0);
                    return f === 'A' ? 'score-A' : f === 'B' ? 'score-B' : f === 'C' ? 'score-C' : 'score-D';
                }

                // New Helpers for V4
                const getSentimentText = (val) => {
                    if (val < 20) return 'ÊûÅÂ∫¶ÊÅêÊÖå';
                    if (val < 40) return 'ÊÅêÊÖå';
                    if (val < 60) return '‰∏≠ÊÄß';
                    if (val < 80) return 'Ë¥™Â©™';
                    return 'ÊûÅÂ∫¶Ë¥™Â©™';
                };

                const getSentimentColor = (val) => {
                    if (val < 40) return '#ef4444';
                    if (val < 60) return '#f59e0b';
                    return '#10b981';
                };

                const dynamicGreeting = computed(() => {
                    const sentiment = recommendations.value?.market_sentiment || 50;
                    if (sentiment < 30) return "‚òï Â∏ÇÂú∫Ê≥¢Âä®ËæÉÂ§ßÔºåÂª∫ËÆÆÂñùËå∂ËØª‰π¶ÔºåÂáèÂ∞ëÁõØÁõò„ÄÇ";
                    if (sentiment > 70) return "‚öñÔ∏è Â∏ÇÂú∫ÊÉÖÁª™ËøáÁÉ≠ÔºåËØ∑Ë≠¶ÊÉïÈ£éÈô©ÔºåÂàáÂãøÁõ≤ÁõÆËøΩÈ´ò„ÄÇ";
                    return "üëã Ê¨¢ËøéÂõûÊù•Ôºå‰ªäÂ§©‰πü‰∏∫ÊÇ®ÊåëÈÄâ‰∫ÜÊúÄÂÄºÂæóÂÖ≥Ê≥®ÁöÑÊú∫‰ºö„ÄÇ";
                });

                function renderAIContent(text) {
                    if (!text) return '';
                    try {
                        const html = typeof marked !== 'undefined' ? marked.parse(text) : text.replace(/\n/g, '<br>');
                        return typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(html) : html;
                    } catch (e) {
                        return text.replace(/\n/g, '<br>');
                    }
                }

                const activeFundTab = Vue.ref('brief');
                const fundNews = Vue.ref([]);
                const marketNews = Vue.ref([]);
                const fundManager = Vue.ref(null);
                const fundRanks = Vue.ref([]);

                function renderMarkdown(text) {
                    if (!text) return '';
                    try {
                        let html = text.trim();

                        // 1. Structural Pre-processing
                        const sections = [
                            { key: 'Ë°åÊÉÖÁªºËø∞', icon: 'üåè', class: '' },
                            { key: 'AI È¢ÑÂà§', icon: 'ü§ñ', class: 'highlight' },
                            { key: 'Êé®ËçêÂÖ≥Ê≥®', icon: '‚úÖ', class: 'recommend' },
                            { key: 'ËßÑÈÅøË≠¶Âëä', icon: '‚ö†Ô∏è', class: 'avoid' },
                            { key: 'Á≠ñÁï•Âª∫ËÆÆ', icon: 'üí°', class: '' }
                        ];

                        // Convert titles to markers
                        sections.forEach(s => {
                            const reg = new RegExp(`^### ${s.key}|${s.key}:?`, 'gim');
                            html = html.replace(reg, `|MARKER|${s.key}|${s.icon}|`);
                        });

                        // Standard headers
                        html = html
                            .replace(/^### (.*$)/gim, '|MARKER|$1|üöÄ|')
                            .replace(/^## (.*$)/gim, '|MARKER|$1|üåé|');

                        // 2. Split and Wrap into Cards
                        if (html.includes('|MARKER|')) {
                            const parts = html.split('|MARKER|').filter(p => p.trim());
                            let cards = [];

                            for (let i = 0; i < parts.length; i += 3) {
                                if (!parts[i + 1]) break; // Safety
                                const title = parts[i];
                                const icon = parts[i + 1];
                                const content = parts[i + 2] || '';

                                let cardClass = 'strategy-card';
                                if (title.includes('Êé®ËçêÂÖ≥Ê≥®')) cardClass += ' recommend';
                                if (title.includes('ËßÑÈÅøË≠¶Âëä')) cardClass += ' avoid';
                                if (title.includes('AI È¢ÑÂà§')) cardClass += ' highlight';

                                cards.push(`<div class="${cardClass}">
                                    <div class="strategy-title">${icon} ${title}</div>
                                    <div class="strategy-content">${content.trim()}</div>
                                </div>`);
                            }
                            html = cards.join('');
                        }

                        // 3. Highlight Transformation
                        html = html.replace(/\*\*(.*?)\*\*/gim, '<span class="highlight-gold">$1</span>');
                        const highlights = ['ÈôçÂáÜ', 'Âä†ÊÅØ', 'ÂÆΩÊùæ', 'Á¥ßÁº©', 'ÂõûÂçá', 'È£éÈô©', 'ÂèçÂºπ', 'Âà©Â•Ω'];
                        highlights.forEach(h => {
                            const reg = new RegExp(`(?<![">])(${h})(?![^<]*>)`, 'g');
                            html = html.replace(reg, `<span class="highlight-gold">$1</span>`);
                        });

                        // 4. Entity Chips
                        const entities = ['ÂçäÂØº‰Ωì', 'Êñ∞ËÉΩÊ∫ê', 'ÁôΩÈÖí', '‰∫∫Â∑•Êô∫ËÉΩ', 'AI', 'Á∫¢Âà©', 'ÂåªÁñó', 'Ê∂àË¥π', 'ÁßëÊäÄ', 'ÁîµÂ≠ê', 'ÂÜõÂ∑•', 'Âú∞‰∫ß', 'ÈáëËûç', 'ÂÖâ‰ºè', 'ÂÇ®ËÉΩ', 'ÁîµÊ±†', 'ÈáèÂåñ', 'ÈÄöËÉÄ'];
                        entities.forEach(entity => {
                            const reg = new RegExp(`(?<![">])(${entity})(?![^<]*>)`, 'g');
                            html = html.replace(reg, `<span class="entity-link" onclick="window.appSearch('$1')">üè∑Ô∏è $1</span>`);
                        });

                        // 5. Cleanup Line Breaks
                        html = html
                            .replace(/^\- (.*$)/gim, '<div style="display:flex;gap:0.5rem;margin-bottom:0.25rem;"><span style="color:var(--primary)">‚Ä¢</span><span>$1</span></div>')
                            .replace(/\n\n/g, '<br/>')
                            .replace(/\n/g, '<br/>');

                        return `<div class="strategy-container">${html}</div>`;
                    } catch (e) {
                        console.error('Markdown error', e);
                        return text;
                    }
                }

                function switchMode(newMode) {
                    mode.value = newMode;
                    if (newMode === 'recommend') fetchRecommendations();
                    if (newMode === 'channel') {
                        fetchMarketHotspots();
                        fetchHotSectors();
                        fetchRankings(rankTab.value || 'score');
                    }
                    if (newMode === 'gainers') fetchTopGainers();
                    if (newMode === 'portfolio') fetchPortfolio();
                    if (newMode === 'watchlist') {
                        fetchWatchlist();
                        startWatchlistTimer();
                    } else {
                        stopWatchlistTimer();
                    }
                }

                async function openSectorDetail(sectorName) {
                    selectedSector.value = sectorName;
                    loadingSectorDetail.value = true;
                    showSectorModal.value = true;
                    sectorDetail.value = null;

                    try {
                        const res = await fetch(`${API_BASE}/v1/sectors/${sectorName}/analyze`);
                        const data = await res.json();
                        if (data.status === 'success') {
                            sectorDetail.value = data.data;
                        } else {
                            errorMsg.value = 'ÂàÜÊûêÊùøÂùóÂ§±Ë¥•: ' + (data.message || 'Êú™Áü•ÈîôËØØ');
                        }
                    } catch (e) {
                        errorMsg.value = 'Êó†Ê≥ïËøûÊé•ÂàÜÊûêÊúçÂä°: ' + e.message;
                    } finally {
                        loadingSectorDetail.value = false;
                    }
                }

                function closeFundDetail() {
                    fundDetail.value = null;
                    showRadar.value = false;
                    showDca.value = false;
                    document.body.style.overflow = '';
                }

                // Deleted Stock/Crypto logic

                // ========== PORTFOLIO ==========
                async function fetchRecommendations() {
                    loading.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/recommend`);
                        const data = await res.json();
                        recommendations.value = data;
                        recommendAiSummary.value = data.ai_summary || '';
                        // Fetch predictions as well
                        fetchPredictions();
                    } catch (e) {
                        showError('Ëé∑ÂèñÊé®ËçêÂ§±Ë¥•: ' + e.message);
                    } finally {
                        loading.value = false;
                    }
                }

                async function fetchPredictions() {
                    try {
                        const res = await fetch(`${API_BASE}/predict_tomorrow`);
                        const data = await res.json();
                        if (data.success) {
                            predictions.value = data.results || [];
                        }
                    } catch (e) {
                        console.error('Fetch predictions failed', e);
                    }
                }

                function onSearchInput() {
                    clearTimeout(searchTimer);
                    if (searchQuery.value.trim().length >= 2) {
                        searchTimer = setTimeout(() => doSearch(), 300);
                    } else {
                        searchResults.value = [];
                    }
                }

                async function fetchFullList() {
                    if (fullFundList.value.length) return;
                    try {
                        const res = await fetch(`${STORAGE_BASE}/fund_list.json`);
                        fullFundList.value = await res.json();
                    } catch (e) {
                        console.error('Failed to load fund list', e);
                    }
                }

                async function handleSearch() {
                    const query = searchQuery.value.trim();
                    searchInterpretation.value = ''; // Clear previous deep search info
                    if (!query) return;

                    // Simple keyword match first
                    await fetchFullList();
                    const filtered = fullFundList.value.filter(f =>
                        f.name.includes(query) || f.code.includes(query)
                    );

                    if (filtered.length > 0) {
                        searchResults.value = filtered;
                    } else {
                        // Fallback to Server Search if local search yields nothing
                        searchLoading.value = true;
                        try {
                            const res = await fetch(`${API_BASE}/search?q=${encodeURIComponent(query)}`);
                            const data = await res.json();
                            // Transform server results to match local structure if needed
                            searchResults.value = (data.results || []).map(r => ({
                                code: r.code,
                                name: r.name,
                                themes: r.themes || [],
                                return_1y: r.return_1y, // Keep return_1y from server
                                score: r.score
                            }));
                        } catch (e) {
                            console.error('Server search failed', e);
                        } finally {
                            searchLoading.value = false;
                        }
                    }
                }

                async function handleDeepSearch() {
                    const query = searchQuery.value.trim();
                    if (!query) return;

                    searchLoading.value = true;
                    try {
                        // 1. Ask AI for semantic filters
                        const res = await fetch(`${API_BASE}/search/deep?q=${encodeURIComponent(query)}`);
                        const data = await res.json();

                        if (!data.success) throw new Error(data.error);
                        const filters = data.filters;
                        searchInterpretation.value = data.interpretation || '';

                        // 2. Load list & Filter locally
                        await fetchFullList();
                        let results = [...fullFundList.value];

                        // Apply Filters (themes, return_1y, max_drawdown)
                        if (filters.themes && filters.themes.length) {
                            results = results.filter(f =>
                                filters.themes.some(t => (f.themes || []).includes(t) || f.name.includes(t))
                            );
                        }
                        if (filters.return_1y) {
                            const { op, val } = filters.return_1y;
                            results = results.filter(f => op === '>' ? f.return_1y > val : f.return_1y < val);
                        }
                        if (filters.max_drawdown_1y) {
                            const { op, val } = filters.max_drawdown_1y;
                            results = results.filter(f => op === '>' ? (f.max_drawdown_1y || 0) > val : (f.max_drawdown_1y || 0) < val);
                        }
                        if (filters.sharpe_1y) {
                            const { op, val } = filters.sharpe_1y;
                            results = results.filter(f => op === '>' ? (f.sharpe_1y || 0) > val : (f.sharpe_1y || 0) < val);
                        }

                        searchResults.value = results.slice(0, 50); // Limit results
                    } catch (e) {
                        showError('Ê∑±Â∫¶ÊêúÁ¥¢Â§±Ë¥•: ' + e.message);
                    } finally {
                        searchLoading.value = false;
                    }
                }

                function doSearch() {
                    handleSearch();
                }

                async function analyzeFundByCode(code) {
                    searchLoading.value = true;
                    fundDetail.value = null;
                    activeFundTab.value = 'brief';

                    try {
                        // 1. Try Static JSON fetch
                        const res = await fetch(`${STORAGE_BASE}/details/${code}.json`);
                        if (res.ok) {
                            const data = await res.json();
                            fundDetail.value = data;
                            fundManager.value = data.metrics?.manager || null;
                            fundRanks.value = data.metrics?.ranks || [];
                        } else {
                            // 2. Fallback to API if static fails
                            console.warn(`Static data for ${code} not found, falling back to API...`);
                            const apiRes = await fetch(`${API_BASE}/analyze/${code}`);
                            const apiData = await apiRes.json();

                            // Advanced Map API data to V4 detail format
                            const m = apiData.metrics || {};
                            fundDetail.value = {
                                code: apiData.code,
                                name: apiData.name,
                                score: m.score || '--',
                                grade: m.grade || 'C',
                                nav_date: m.nav_date || '',
                                metrics: {
                                    ...m,
                                    nav: m.latest_nav,
                                    change_percent: m.return_1d
                                },
                                chart_data: apiData.chart_data || [],
                                history_nav: apiData.chart_data || [],
                                holdings: apiData.holdings || [],
                                events: apiData.events || [],
                                ai_analysis: apiData.ai_analysis || '',
                                ai_v4_analysis: apiData.ai_v4_analysis || null
                            };
                            fundManager.value = apiData.manager || null;
                            fundRanks.value = apiData.ranks || [];
                        }

                        // Common follow-up actions
                        fetchFundNews(code);
                        fetchStructuredAnalysis(code);
                        document.body.style.overflow = 'hidden';

                    } catch (e) {
                        showError('ËØ¶ÊÉÖÂä†ËΩΩÂ§±Ë¥•: ' + e.message);
                    } finally {
                        searchLoading.value = false;
                    }
                }

                async function fetchStructuredAnalysis(code) {
                    try {
                        const res = await fetch(`${API_BASE}/analyze/${code}/v4`);
                        const ana = await res.json();
                        if (fundDetail.value && fundDetail.value.code === code) {
                            fundDetail.value.v4_analysis = ana;
                        }
                    } catch (e) {
                        console.error('Fetch structured analysis failed', e);
                    }
                }

                async function fetchFundNews(code) {
                    try {
                        const res = await fetch(`${API_BASE}/news/fund/${code}`);
                        const data = await res.json();
                        if (data.success) {
                            fundNews.value = data.news || [];
                            // If there is AI analysis for news, we could append it or show in News tab
                        }
                    } catch (e) {
                        console.error('Fetch news failed', e);
                    }
                }

                async function fetchMarketNews() {
                    try {
                        const res = await fetch(`${API_BASE}/news/market`);
                        const data = await res.json();
                        if (data.success) {
                            marketNews.value = data.news || [];
                        }
                    } catch (e) {
                        console.error('Fetch market news failed', e);
                    }
                }

                function runDcaSimulation() {
                    if (!fundDetail.value?.history_nav?.length) return;

                    const history = fundDetail.value.history_nav;
                    const amount = 1000; // Weekly 1000
                    let totalInvested = 0;
                    let totalShares = 0;

                    // Simplified: Buy every 5 data points (roughly weekly if daily data)
                    for (let i = 0; i < history.length; i += 5) {
                        const nav = parseFloat(history[i].nav);
                        if (isNaN(nav) || nav <= 0) continue;
                        totalShares += amount / nav;
                        totalInvested += amount;
                    }

                    const latestNav = parseFloat(history[history.length - 1].nav);
                    const currentValue = totalShares * latestNav;
                    const profit = currentValue - totalInvested;
                    const yieldRate = (profit / totalInvested) * 100;

                    dcaResults.value = {
                        totalInvested,
                        currentValue,
                        profit,
                        yield: yieldRate.toFixed(2),
                        count: Math.floor(history.length / 5)
                    };
                }

                const calculateTotalFee = (amount, years, rate) => {
                    // Simple annual compounding fee drag
                    return amount * (1 - Math.pow(1 - rate / 100, years));
                };

                // Export search to window for entity links
                window.appSearch = (query) => {
                    searchQuery.value = query;
                    mode.value = 'search';
                    handleSearch();
                };

                async function fetchTopGainers() {
                    gainerLoading.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/top-gainers?period=${gainerPeriod.value}&limit=20`);
                        const data = await res.json();
                        if (data.success) {
                            topGainers.value = data.data.funds || [];
                        }
                    } catch (e) {
                        console.error(e);
                    } finally {
                        gainerLoading.value = false;
                    }
                }

                async function fetchPortfolio() {
                    try {
                        const positions = await LocalDB.getAll('portfolio');
                        portfolio.value = positions;
                        // Local Calculation
                        const total_cost = positions.reduce((sum, p) => sum + (p.shares * (p.cost_price || 1)), 0);
                        portfolioSummary.value = {
                            total_positions: positions.length,
                            total_cost: total_cost
                        };
                    } catch (e) {
                        console.error(e);
                    }
                }

                async function buyFund(code, name) {
                    const input = prompt(`ËØ∑ËæìÂÖ•‰π∞ÂÖ•‰ªΩÈ¢ù\nÂü∫Èáë: ${name || code}`, '1000');
                    if (!input) return;
                    const shares = parseFloat(input);
                    if (isNaN(shares) || shares <= 0) {
                        showError('ËØ∑ËæìÂÖ•ÊúâÊïà‰ªΩÈ¢ù');
                        return;
                    }

                    try {
                        // For static version, we use 1.0 as cost_price if not available
                        const cost_price = 1.0;
                        await LocalDB.put('portfolio', {
                            fund_code: code,
                            fund_name: name,
                            shares,
                            cost_price,
                            buy_date: new Date().toISOString(),
                            status: 'holding'
                        });
                        showError('‚úÖ Â∑≤ËÆ∞ÂÖ•Êú¨Âú∞ÊåÅ‰ªì');
                        fetchPortfolio();
                    } catch (e) {
                        showError('‰øùÂ≠òÂ§±Ë¥•');
                    }
                }

                async function sellPosition(positionId) {
                    if (!confirm('Á°ÆÂÆöË¶ÅÁßªÈô§Ê≠§ÊåÅ‰ªìÂêóÔºü')) return;
                    try {
                        await LocalDB.delete('portfolio', positionId);
                        showError('‚úÖ Â∑≤‰ªéÊú¨Âú∞ÁßªÈô§');
                        fetchPortfolio();
                    } catch (e) {
                        showError('Êìç‰ΩúÂ§±Ë¥•');
                    }
                }

                async function fetchWatchlist() {
                    watchlistLoading.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/watchlist/realtime`);
                        const data = await res.json();
                        if (data.success) {
                            watchlist.value = data.data;
                        }
                    } catch (e) {
                        console.error('Fetch watchlist failed', e);
                    } finally {
                        watchlistLoading.value = false;
                    }
                }

                async function addToWatchlist(code, name) {
                    try {
                        const res = await fetch(`${API_BASE}/watchlist/add`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code, name })
                        });
                        const data = await res.json();
                        if (data.success) {
                            showError('‚úÖ Â∑≤Âä†ÂÖ•Ëá™ÈÄâ');
                            fetchWatchlist();
                        } else {
                            showError('Ê∑ªÂä†Â§±Ë¥•: ' + (data.error || ''));
                        }
                    } catch (e) {
                        showError('ÁΩëÁªúÈîôËØØ');
                    }
                }

                let watchlistTimer = null;
                function startWatchlistTimer() {
                    stopWatchlistTimer();
                    watchlistTimer = setInterval(() => {
                        if (mode.value === 'watchlist' && !watchlistLoading.value) {
                            fetchWatchlistSilent();
                        }
                    }, 30000); // 30 seconds refresh
                }

                function stopWatchlistTimer() {
                    if (watchlistTimer) {
                        clearInterval(watchlistTimer);
                        watchlistTimer = null;
                    }
                }

                async function fetchWatchlistSilent() {
                    try {
                        const res = await fetch(`${API_BASE}/watchlist/realtime`);
                        const data = await res.json();
                        if (data.success) {
                            watchlist.value = data.data;
                        }
                    } catch (e) { }
                }

                function generateSparkline(data) {
                    if (!data || data.length < 2) return '';
                    const width = 400;
                    const height = 30;
                    const points = data.map(d => d.growth);
                    const min = Math.min(...points);
                    const max = Math.max(...points);
                    const range = max - min || 1;

                    return data.map((d, i) => {
                        const x = (i / (data.length - 1)) * 100 + '%';
                        const y = height - ((d.growth - min) / range * height);
                        return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                    }).join(' ');
                }

                async function handlePortfolioDiagnose() {
                    if (!portfolio.value.length) return;
                    showDiagnosis.value = true;
                    diagnosisReport.value = '';
                    searchLoading.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/portfolio/diagnose`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(portfolio.value)
                        });
                        const data = await res.json();
                        if (data.success) {
                            diagnosisReport.value = data.report;
                            // Trigger pro diagnosis as well
                            runDiagnosePro();
                        } else {
                            showError('ËØäÊñ≠Â§±Ë¥•: ' + data.error);
                            showDiagnosis.value = false;
                        }
                    } catch (e) {
                        showError('ËØ∑Ê±ÇÂ§±Ë¥•');
                        showDiagnosis.value = false;
                    } finally {
                        searchLoading.value = false;
                    }
                }

                async function runDiagnosePro() {
                    loadingDiagnosePro.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/v1/diagnose/pro`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                funds: portfolio.value.map(p => ({ code: p.fund_code, weight: 100 / portfolio.value.length }))
                            })
                        });
                        const data = await res.json();
                        if (data.status === 'success') {
                            diagnoseProData.value = data.data;
                        }
                    } catch (e) {
                        console.error('Pro diagnosis failed', e);
                    } finally {
                        loadingDiagnosePro.value = false;
                    }
                }

                async function handleExportImage(elementId) {
                    const el = document.getElementById(elementId);
                    if (!el) return;

                    try {
                        const canvas = await html2canvas(el, {
                            backgroundColor: '#0f172a',
                            scale: 2,
                            useCORS: true
                        });
                        const link = document.createElement('a');
                        link.download = `FundAdvisor_Report_${new Date().getTime()}.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        showError('‚úÖ Â∑≤ÁîüÊàêÂàÜ‰∫´ÂõæÂπ∂Â∞ùËØï‰∏ãËΩΩ');
                    } catch (e) {
                        showError('ÁîüÊàêÂàÜ‰∫´ÂõæÂ§±Ë¥•: ' + e.message);
                    }
                }

                async function removeFromWatchlist(code) {
                    if (!confirm('Á°ÆÂÆöË¶ÅÁßªÈô§ÂêóÔºü')) return;
                    try {
                        const res = await fetch(`${API_BASE}/watchlist/remove`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code })
                        });
                        const data = await res.json();
                        if (data.success) {
                            watchlist.value = watchlist.value.filter(f => f.code !== code);
                        }
                    } catch (e) {
                        showError('ÁßªÈô§Â§±Ë¥•');
                    }
                }

                async function triggerUpdate() {
                    if (!adminToken.value.trim()) {
                        updateMessage.value = 'ËØ∑ËæìÂÖ• Token';
                        updateSuccess.value = false;
                        return;
                    }

                    updating.value = true;
                    updateMessage.value = '';
                    try {
                        const res = await fetch(`${API_BASE}/admin/build-static`, {
                            method: 'POST',
                            headers: { 'X-Admin-Token': adminToken.value.trim() }
                        });
                        const data = await res.json();
                        if (res.ok && data.success) {
                            updateSuccess.value = true;
                            updateMessage.value = data.message || 'ÈùôÊÄÅÊï∞ÊçÆÊûÑÂª∫Â∑≤ÂêØÂä®';
                            setTimeout(() => { showUpdateDialog.value = false; }, 2000);
                        } else {
                            updateSuccess.value = false;
                            updateMessage.value = data.detail || data.error || 'ÂêåÊ≠•Â§±Ë¥•';
                        }
                    } catch (e) {
                        updateSuccess.value = false;
                        updateMessage.value = 'ËØ∑Ê±ÇÂ§±Ë¥•: ' + e.message;
                    } finally {
                        updating.value = false;
                    }
                }

                async function fetchMarketHotspots() {
                    loadingHotspots.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/v1/market/hotspots`);
                        const data = await res.json();
                        if (data.status === 'success') {
                            marketHotspots.value = data;
                        }
                    } catch (e) {
                        console.error('Fetch hotspots failed', e);
                    } finally {
                        loadingHotspots.value = false;
                    }
                }

                async function fetchHotSectors() {
                    loadingSectors.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/v1/sectors/hot`);
                        const data = await res.json();
                        if (data.status === 'success') {
                            hotSectors.value = data.data;
                        }
                    } catch (e) {
                        console.error('Fetch sectors failed', e);
                    } finally {
                        loadingSectors.value = false;
                    }
                }

                async function fetchRankings(tab = 'score') {
                    rankTab.value = tab;
                    loadingRankings.value = true;
                    try {
                        // Include filters in ranking fetch
                        const queryParams = new URLSearchParams({
                            sort_by: tab,
                            limit: 20
                        });
                        if (activeFilters.value.scale !== 'all') queryParams.append('min_scale', activeFilters.value.scale);
                        if (activeFilters.value.tenure !== 'all') queryParams.append('min_tenure', activeFilters.value.tenure);

                        const res = await fetch(`${API_BASE}/v1/rankings?${queryParams.toString()}`);
                        const data = await res.json();
                        if (data.status === 'success') {
                            rankingListData.value = data.data;
                        }
                    } catch (e) {
                        console.error('Fetch rankings failed', e);
                    } finally {
                        loadingRankings.value = false;
                    }
                }

                async function applyFilters() {
                    showFilterDrawer.value = false;
                    fetchRankings(rankTab.value);
                }

                async function sendChatMessage() {
                    if (!chatInput.value || chatLoading.value) return;

                    const query = chatInput.value;
                    chatMessages.value.push({ role: 'user', content: query });
                    chatInput.value = '';
                    chatLoading.value = true;

                    try {
                        const res = await fetch(`${API_BASE}/v1/ai/chat/query`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query: query, history: chatMessages.value.slice(-5) })
                        });
                        const data = await res.json();
                        if (data.status === 'success') {
                            chatMessages.value.push({
                                role: 'ai',
                                content: data.interpretation,
                                funds: data.funds
                            });
                            // Auto scroll to bottom
                            setTimeout(() => {
                                const el = document.getElementById('chatMessages');
                                if (el) el.scrollTop = el.scrollHeight;
                            }, 50);
                        } else {
                            chatMessages.value.push({ role: 'ai', content: 'Êä±Ê≠âÔºåÊàëÁé∞Âú®Êó†Ê≥ïËß£ÊûêÊÇ®ÁöÑÈúÄÊ±ÇÔºåËØ∑Â∞ùËØïÊç¢‰∏ÄÁßçËØ¥Ê≥ï„ÄÇ' });
                        }
                    } catch (e) {
                        chatMessages.value.push({ role: 'ai', content: 'ËøûÊé• AI ÊúçÂä°Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ' });
                    } finally {
                        chatLoading.value = false;
                    }
                }

                const getSectorIcon = (sector) => {
                    const icons = {
                        'Â§ßÊ∂àË¥π': 'üõí', 'ÁôΩÈÖí': 'üç∑', 'È£üÂìÅÈ•ÆÊñô': 'üçî', 'ÂÆ∂Áîµ': 'üì∫', 'ÁæéÂ¶Ü': 'üíÑ', 'ÊóÖÊ∏∏ÈÖíÂ∫ó': 'üè®', 'ÂÜú‰∏öÂÖªÊÆñ': 'üê∑',
                        'ÂåªÁñó‰øùÂÅ•': 'üè•', 'ÂåªËçØ': 'üíä', 'ÁîüÁâ©Âà∂ÂìÅ': 'üß¨', '‰∏≠ËçØ': 'üåø', 'ÂåªÁñóÂô®Ê¢∞': 'ü©ª',
                        'ÁßëÊäÄÂàõÊñ∞': 'üöÄ', 'ÂçäÂØº‰Ωì': 'üíæ', 'ÁîµÂ≠ê': 'üì±', '‰∫∫Â∑•Êô∫ËÉΩ': 'ü§ñ', 'ËΩØ‰ª∂': 'üíª', 'ÈÄö‰ø°': 'üì°', '‰∫ëËÆ°ÁÆó': '‚òÅÔ∏è',
                        'Êñ∞ËÉΩÊ∫ê': '‚ö°', 'ÂÖâ‰ºè': '‚òÄÔ∏è', 'ÈîÇÁîµÊ±†': 'üîã', 'È£éÁîµ': 'üå¨Ô∏è', 'ÁîµÂäõ': 'üîå',
                        'ÈáëËûçÂú∞‰∫ß': 'üè¶', 'Èì∂Ë°å': 'üèõÔ∏è', 'ÈùûÈì∂ÈáëËûç': 'üíπ', 'ÊàøÂú∞‰∫ß': 'üè†', 'Âà∏ÂïÜ': 'üìä',
                        'È´òÁ´ØÂà∂ÈÄ†': 'üè≠', 'Â∑•‰∏ö': '‚öôÔ∏è', 'ÂÜõÂ∑•': 'üõ°Ô∏è', 'Âü∫Âª∫': 'üèóÔ∏è', 'Ê±ΩËΩ¶': 'üöó',
                        'ËµÑÊ∫êËÉΩÊ∫ê': 'üõ¢Ô∏è', 'ÁÖ§ÁÇ≠': 'ü™µ', 'ÊúâËâ≤ÈáëÂ±û': 'üíé', 'Èí¢ÈìÅ': '‚õìÔ∏è', 'Áü≥Âåñ': '‚õΩ'
                    };
                    return icons[sector] || 'üè∑Ô∏è';
                };

                // ÁîüÂëΩÂë®Êúü
                onMounted(() => {
                    fetchRecommendations();
                    fetchMarketNews();
                    // ÂàùÂßãÂåñ Lucide ÂõæÊ†á
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                });

                return {
                    mode, loading, errorMsg,
                    recommendations, recTab, recTabs, currentList,
                    searchQuery, searchResults, searchLoading, fundDetail,
                    topGainers, gainerPeriod, gainerLoading, gainerPeriods,
                    portfolio, portfolioSummary,
                    watchlist, watchlistLoading,
                    showUpdateDialog, adminToken, updating, updateMessage, updateSuccess,
                    showError, getScoreClass, renderAIContent, switchMode,
                    fetchRecommendations, onSearchInput, doSearch, analyzeFundByCode,
                    fetchTopGainers, fetchPortfolio, buyFund, sellPosition,
                    fetchWatchlist, addToWatchlist, removeFromWatchlist, triggerUpdate,

                    // Deep Dive
                    activeFundTab, fundNews, fundManager, fundRanks, closeFundDetail,
                    marketNews,
                    recommendAiSummary, renderMarkdown,
                    fetchStructuredAnalysis,
                    scannerTags, handleSearch, handleDeepSearch,
                    showDiagnosis, diagnosisReport, handlePortfolioDiagnose,
                    handleExportImage, generateSparkline,

                    // Professional Features Methods
                    macroData,
                    fetchMacroData: async () => {
                        try {
                            const res = await fetch(`${API_BASE}/macro/dashboard`);
                            macroData.value = (await res.json()).data;
                        } catch (e) { console.error(e); }
                    },
                    backtestResult,
                    backtestLoading,
                    runBacktest: async (portfolioList) => {
                        backtestLoading.value = true;
                        try {
                            const res = await fetch(`${API_BASE}/portfolio/backtest`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(portfolioList)
                            });
                            backtestResult.value = await res.json();
                        } catch (e) { showError('ÂõûÊµãÂ§±Ë¥•'); }
                        finally { backtestLoading.value = false; }
                    },
                    feeCalculator,
                    calculateFee: async () => {
                        feeCalculator.value.loading = true;
                        try {
                            const { amount, years, rate } = feeCalculator.value;
                            const res = await fetch(`${API_BASE}/fee/calculate?amount=${amount}&years=${years}&rate=${rate}`);
                            const data = await res.json();
                            if (data.success) feeCalculator.value.result = data;
                        } catch (e) { showError('ËÆ°ÁÆóÂ§±Ë¥•'); }
                        finally { feeCalculator.value.loading = false; }
                    },
                    showWiki: (term) => {
                        showError(`üìñ ${term}: ${wikiTerms[term] || 'ÊöÇÊó†ËØ¶ÁªÜËß£Èáä'}`);
                    },

                    // V4 additions
                    predictions, getSentimentText, getSentimentColor, dynamicGreeting,
                    showRadar, defaultRadar, showDca, dcaResults, runDcaSimulation, calculateTotalFee,
                    chartPath, crashMarkers,
                    compareList, showPk, toggleCompare,

                    // Fund Channel Methods
                    marketHotspots, hotSectors, rankingListData, rankTab,
                    loadingRankings, loadingHotspots, loadingSectors,
                    fetchMarketHotspots, fetchHotSectors, fetchRankings,
                    getSectorIcon, openSectorDetail,
                    showSectorModal, selectedSector, sectorDetail, loadingSectorDetail,

                    // Phase 3 Additions
                    compareData, loadingCompare, fetchComparisonMatrix,
                    diagnoseProData, loadingDiagnosePro, runDiagnosePro,
                    showFilterDrawer, activeFilters, applyFilters,

                    // Phase 4 Additions
                    showChat, chatInput, chatMessages, chatLoading, sendChatMessage
                };
            }
        }).mount('#app');
    </script>
</body>

</html>