<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FundAdvisor Pro | æç®€ã€ä¸“ä¸šã€AIé©±åŠ¨ (v4.0 Edge)</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’°</text></svg>">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .nav-locked { opacity: 0.35; cursor: not-allowed !important; font-size: 0.8rem; }
        .nav-locked:hover { background: transparent !important; }
        .ai-dot.pulse { animation: pulse-dot 1.5s infinite; }
        @keyframes pulse-dot { 0%,100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.6); opacity: 0.6; } }
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <!-- é”™è¯¯æç¤º -->
        <div v-if="errorMsg" class="error-toast" @click="errorMsg=''">{{ errorMsg }}</div>

        <div class="app-container">
            <!-- Onboarding -->
            <onboarding-guide v-if="showOnboarding" @onboarding-complete="handleOnboardingComplete"></onboarding-guide>

            <!-- Sidebar Component -->
            <sidebar :mode="mode" :is-dark="isDark" :notifications="notifications"
                :show-notifications="showNotifications" :experience-level="experienceLevel"
                @switch-mode="switchMode" @toggle-theme="toggleTheme"
                @toggle-notifications="showNotifications = !showNotifications" @mark-read="markNotifRead"
                @show-update-dialog="showUpdateDialog = true"></sidebar>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Dynamic Emotional Greeting -->
                <div class="glass-card"
                    style="margin-bottom: 2rem; padding: 1rem 1.5rem; border-left: 4px solid var(--primary); display: flex; align-items: center; gap: 1rem;">
                    <div style="font-size: 1.2rem;">ğŸ’¡</div>
                    <div style="font-size: 0.95rem; font-weight: 500; color: var(--text-muted);">{{ dynamicGreeting }}
                    </div>
                </div>

                <!-- Dashboard -->
                <dashboard-view v-if="mode === 'dashboard'" :dashboard-data="dashboardData" :loading="dashboardLoading"
                    @switch-mode="switchMode" @analyze-fund="analyzeFundByCode" @refresh="fetchDashboard"></dashboard-view>

                <recommend-view v-if="mode === 'recommend'" :loading="loading" :recommendations="recommendations"
                    :actions="dailyActions" :loading-actions="loadingDailyActions" v-model:rec-tab="recTab"
                    :predictions="predictions" :market-news="marketNews" :compare-list="compareList"
                    :render-markdown="renderMarkdown" :get-sentiment-text="getSentimentText"
                    :get-score-class="getScoreClass" @analyze-fund="analyzeFundByCode" @toggle-compare="toggleCompare"
                    @search-query="window.appSearch($event)"></recommend-view>

                <channel-view v-if="mode === 'channel'" :market-hotspots="marketHotspots" :rank-tab="rankTab"
                    :ranking-list-data="rankingListData" :hot-sectors="hotSectors" :loading-rankings="loadingRankings"
                    :loading-hotspots="loadingHotspots" :loading-sectors="loadingSectors"
                    :get-sector-icon="getSectorIcon" :get-score-class="getScoreClass"
                    @open-sector-detail="openSectorDetail" @analyze-fund="analyzeFundByCode"
                    @fetch-rankings="fetchRankings"></channel-view>

                <gainers-view v-if="mode === 'gainers'" :gainer-periods="gainerPeriods"
                    v-model:gainer-period="gainerPeriod" :gainer-loading="gainerLoading" :top-gainers="topGainers"
                    :compare-list="compareList" @fetch-top-gainers="fetchTopGainers" @analyze-fund="analyzeFundByCode"
                    @toggle-compare="toggleCompare"></gainers-view>

                <search-view v-if="mode === 'search'" v-model:search-query="searchQuery" :search-loading="searchLoading"
                    :scanner-tags="scannerTags" :search-interpretation="searchInterpretation"
                    :search-results="searchResults" :compare-list="compareList" @handle-search="handleSearch"
                    @handle-deep-search="handleDeepSearch" @analyze-fund="analyzeFundByCode"
                    @toggle-compare="toggleCompare"></search-view>

                <portfolio-view v-if="mode === 'portfolio'" :portfolio="portfolio" :portfolio-summary="portfolioSummary"
                    :search-loading="searchLoading" :backtest-loading="backtestLoading"
                    :backtest-result="backtestResult" v-model:show-diagnosis="showDiagnosis"
                    :diagnosis-report="diagnosisReport" :diagnose-pro-data="diagnoseProData"
                    :loading-diagnose-pro="loadingDiagnosePro" :render-markdown="renderMarkdown"
                    @handle-portfolio-diagnose="handlePortfolioDiagnose" @handle-export-image="handleExportImage"
                    @fetch-portfolio="fetchPortfolio" @analyze-fund="analyzeFundByCode" @sell-position="sellPosition"
                    @run-backtest="runBacktest"></portfolio-view>

                <watchlist-view v-if="mode === 'watchlist'" :watchlist-loading="watchlistLoading" :watchlist="watchlist"
                    :generate-sparkline="generateSparkline" @fetch-watchlist="fetchWatchlist"
                    @analyze-fund="analyzeFundByCode" @remove-from-watchlist="removeFromWatchlist"
                    @switch-mode="mode = $event"></watchlist-view>

                <macro-view v-if="mode === 'macro'" :macro-data="macroData"
                    @fetch-macro-data="fetchMacroData"></macro-view>

                <dca-management v-if="mode === 'dca'" :plans="dcaPlans" :loading="loadingDca"
                    @update-plan-status="updateDcaStatus" @analyze-fund="analyzeFundByCode"
                    @switch-mode="switchMode"></dca-management>

                <history-view v-if="mode === 'history'" :history="recommendationHistory" :loading="loadingHistory"
                    @fetch-history="fetchHistory" @analyze-fund="analyzeFundByCode"></history-view>

                <tools-view v-if="mode === 'tools'" :fee-calculator="feeCalculator"
                    :portfolio-builder="portfolioBuilder" @calculate-fee="calculateFee"
                    @build-portfolio="buildPortfolio" @analyze-fund="analyzeFundByCode"></tools-view>

                <!-- Monthly Report -->
                <monthly-report-view v-if="mode === 'report'" :report-data="monthlyReportData"
                    :loading="monthlyReportLoading" @handle-export-image="handleExportImage"></monthly-report-view>

                <!-- Behavior Profile -->
                <behavior-profile v-if="mode === 'behavior'" :profile-data="behaviorProfileData"
                    :loading="behaviorProfileLoading"></behavior-profile>
            </main>
        </div>

        <!-- Modals & System Components -->
        <sector-modal v-model:show-sector-modal="showSectorModal" :selected-sector="selectedSector"
            :get-sector-icon="getSectorIcon" :sector-detail="sectorDetail" :loading-sector-detail="loadingSectorDetail"
            :render-markdown="renderMarkdown" @analyze-fund="analyzeFundByCode"
            @search-by-theme="searchByTheme"></sector-modal>

        <fund-detail-modal :fund-detail="fundDetail" v-model:active-fund-tab="activeFundTab"
            :get-score-class="getScoreClass" v-model:show-radar="showRadar" :default-radar="defaultRadar"
            :render-ai-content="renderAIContent" :chart-path="chartPath" :crash-markers="crashMarkers"
            :fund-ranks="fundRanks" v-model:show-dca="showDca" :dca-results="dcaResults"
            :calculate-total-fee="calculateTotalFee" :fund-manager="fundManager" :fund-news="fundNews"
            :render-markdown="renderMarkdown" @close="closeFundDetail" @run-dca-simulation="runDcaSimulation"
            @buy-fund="buyFund" @add-to-watchlist="addToWatchlist"
            @analyze-fund="analyzeFundByCode"></fund-detail-modal>

        <pk-modal v-model:show-pk="showPk" :loading-compare="loadingCompare" :compare-data="compareData"
            :get-score-class="getScoreClass"></pk-modal>

        <filter-drawer v-model:show-filter-drawer="showFilterDrawer" v-model:active-filters="activeFilters"
            @apply-filters="applyFilters"></filter-drawer>

        <ai-chat-panel v-model:show-chat="showChat" :chat-messages="chatMessages" v-model:chat-input="chatInput"
            :chat-loading="chatLoading" :render-markdown="renderMarkdown" :get-score-class="getScoreClass"
            @send-message="sendChatMessage" @analyze-fund="analyzeFundByCode"></ai-chat-panel>

        <!-- Admin Update Dialog -->
        <div v-if="showUpdateDialog" class="modal-overlay" @click.self="showUpdateDialog = false">
            <div class="glass-card" style="max-width: 400px; width: 90%; padding: 2rem; text-align: center;">
                <h2 class="section-title" style="justify-content: center; margin-bottom: 1rem;">ğŸ”„ åŒæ­¥æ•°æ®</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">è¾“å…¥ç®¡ç†å‘˜ Token ä»¥åŒæ­¥æœ€æ–°æ•°æ®</p>
                <div v-if="updateMessage"
                    :style="{padding: '1rem', borderRadius: '8px', marginBottom: '1rem', background: updateSuccess ? 'rgba(16, 185, 129, 0.1)' : 'rgba(244, 63, 94, 0.1)', color: updateSuccess ? 'var(--success)' : 'var(--accent)'}">
                    {{ updateMessage }}
                </div>
                <input type="password" v-model="adminToken" placeholder="ç®¡ç†å‘˜ Token" class="pro-input"
                    style="margin-bottom: 1rem;">
                <div style="display: flex; gap: 1rem;">
                    <button class="pro-btn" style="flex: 1;" @click="triggerUpdate" :disabled="updating">{{ updating ?
                        'åŒæ­¥ä¸­...' : 'å¼€å§‹åŒæ­¥' }}</button>
                    <button class="pro-btn" style="flex: 1; background: rgba(255,255,255,0.05);"
                        @click="showUpdateDialog = false">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- PK Compare Floating Bar -->
        <div v-if="compareList.length > 0" class="compare-bar">
            <div style="font-weight: 700; color: var(--primary);">PK ç¯®å­ ({{ compareList.length }}/3)</div>
            <div class="compare-item" v-for="f in compareList" :key="f.code">
                <span>{{ f.name }}</span>
                <span style="cursor: pointer; opacity: 0.6;" @click="toggleCompare(f)">âœ•</span>
            </div>
            <button class="pro-btn" style="padding: 0.4rem 1.2rem; border-radius: 20px;"
                :disabled="compareList.length < 2" @click="fetchComparisonMatrix">ğŸ¥‡ å¼€å§‹å¯¹æ¯”</button>
        </div>

        <!-- å…è´£å£°æ˜ -->
        <div class="disclaimer">
            âš ï¸ ä»¥ä¸Šåˆ†æä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ã€‚
        </div>
    </div>

    <script type="module" src="js/app.js"></script>
</body>

</html>